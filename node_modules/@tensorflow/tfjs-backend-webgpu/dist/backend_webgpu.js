/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
import './flags_webgpu';
import { backend_util, buffer, DataStorage, engine, env, KernelBackend, util } from '@tensorflow/tfjs-core';
import { AdapterInfo } from './adapter_info';
import { BufferManager } from './buffer_manager';
import { TextureManager } from './texture_manager';
import * as webgpu_program from './webgpu_program';
import * as webgpu_util from './webgpu_util';
// Empirically determined constant used to determine size threshold for handing
// off execution to the CPU.
const CPU_HANDOFF_SIZE_THRESHOLD = env().getNumber('WEBGPU_CPU_HANDOFF_SIZE_THRESHOLD');
// Reshape dispatch, not to exceed device limits.
const reshapeDispatch = (device, program) => {
    const MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE = device.limits.maxComputeWorkgroupsPerDimension;
    const layout = program['dispatchLayout'];
    const dispatch = program['dispatch'];
    if (dispatch.every((d) => d <= MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE)) {
        return dispatch;
    }
    util.assert(dispatch[0] > MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE &&
        layout.y === undefined && layout.z === undefined, () => 'Dispatch size exceeds WebGPU limits in Y or Z dimension.');
    let dispatchAverage = Math.ceil(Math.sqrt(dispatch[0]));
    if (dispatchAverage > MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE) {
        dispatchAverage = Math.ceil(Math.cbrt(dispatch[0]));
        util.assert(dispatchAverage <= MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE, () => 'Total dispatch size exceeds WebGPU maximum.');
        return [dispatchAverage, dispatchAverage, dispatchAverage];
    }
    else {
        return [dispatchAverage, dispatchAverage, 1];
    }
};
export class WebGPUBackend extends KernelBackend {
    constructor(device, adapterInfo) {
        super();
        this.commandQueueOwnedIds = new WeakSet();
        this.dispatchNumberInEncoder = 0;
        this.disposed = false;
        this.downloadWaitMs = 0;
        this.tensorDataPendingDisposal = [];
        this.stagingPendingDisposal = [];
        this.uniformPendingDisposal = [];
        this.uploadWaitMs = 0;
        if (!webgpu_util.isWebGPUSupported()) {
            throw new Error('WebGPU is not supported on this device');
        }
        this.pipelineCache = {};
        this.device = device;
        this.queue = device.queue;
        this.currentCommandEncoder = null;
        this.currentComputePass = null;
        this.supportTimeQuery =
            device.features.has('timestamp-query-inside-passes');
        this.adapterInfo = new AdapterInfo(adapterInfo);
        this.thresholdToIncreaseWorkgroups =
            this.adapterInfo.intelGPUGeneration >= 12 ? 16 : 8;
        this.bufferManager = new BufferManager(this.device);
        this.textureManager = new TextureManager(this.device);
        this.tensorMap = new DataStorage(this, engine());
        if (this.supportTimeQuery) {
            this.querySet = this.device.createQuerySet({
                type: 'timestamp',
                count: 2,
            });
        }
        // Profiling tools like PIX needs this dummy canvas to
        // trigger capturing a frame.
        if (env().getBool('WEBGPU_USE_PROFILE_TOOL')) {
            this.dummyCanvas = document.createElement('canvas');
            this.dummyCanvas.width = 1;
            this.dummyCanvas.height = 1;
            this.dummyContext = this.dummyCanvas.getContext('webgpu');
            this.dummyContext.configure({
                device,
                format: 'bgra8unorm',
            });
            document.body.appendChild(this.dummyCanvas);
        }
    }
    nextDataId() {
        return WebGPUBackend.nextDataId++;
    }
    floatPrecision() {
        return 32;
    }
    defaultGpuBufferUsage() {
        return GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC |
            GPUBufferUsage.COPY_DST;
    }
    /**
     * Dispose the memory if the dataId has 0 refCount. Return true if the memory
     * is released or memory is not managed in this backend, false if memory is
     * not cleared.
     * @param dataId
     * @oaram force Optional, remove the data regardless of refCount
     */
    disposeData(dataId, force = false) {
        if (this.tensorDataPendingDisposal.indexOf(dataId) >= 0) {
            return false;
        }
        if (!this.tensorMap.has(dataId)) {
            return true;
        }
        const tensorData = this.tensorMap.get(dataId);
        this.decRef(dataId);
        if (!force && tensorData.refCount > 0) {
            return false;
        }
        // complex is never in commandQueueOwnedIds
        if (this.commandQueueOwnedIds.has(dataId)) {
            this.tensorDataPendingDisposal.push(dataId);
            return false;
        }
        const { complexTensorInfos } = this.tensorMap.get(dataId);
        if (complexTensorInfos != null) {
            this.disposeData(complexTensorInfos.real.dataId, force);
            this.disposeData(complexTensorInfos.imag.dataId, force);
        }
        this.releaseResource(dataId);
        this.tensorMap.delete(dataId);
        return true;
    }
    memory() {
        return {
            numBytesInGPU: this.bufferManager.numBytesUsed,
            numBytesAllocatedInGPU: this.bufferManager.numBytesAllocated,
            unreliable: false
        };
    }
    releaseResource(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        if (!tensorData || !tensorData.resourceInfo) {
            return;
        }
        // If tensor's resource is from external, do not release.
        if (tensorData.external) {
            tensorData.resourceInfo = null;
            return;
        }
        if ('texture' in tensorData.resourceInfo) {
            const textureInfo = tensorData.resourceInfo;
            if (textureInfo.texture instanceof GPUTexture) {
                this.textureManager.releaseTexture(textureInfo.texture, textureInfo.width, textureInfo.height, textureInfo.format, textureInfo.usage);
            }
            textureInfo.texture = null;
        }
        else {
            const bufferInfo = tensorData.resourceInfo;
            this.bufferManager.releaseBuffer(bufferInfo.buffer, bufferInfo.size, bufferInfo.usage);
            bufferInfo.buffer = null;
        }
        tensorData.resourceInfo = null;
    }
    /** Return refCount of a `TensorData`. */
    refCount(dataId) {
        if (this.tensorMap.has(dataId)) {
            const tensorData = this.tensorMap.get(dataId);
            return tensorData.refCount;
        }
        return 0;
    }
    /** Increase refCount of a `TensorData`. */
    incRef(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        tensorData.refCount++;
    }
    /** Decrease refCount of a `TensorData`. */
    decRef(dataId) {
        if (this.tensorMap.has(dataId)) {
            const tensorData = this.tensorMap.get(dataId);
            tensorData.refCount--;
        }
    }
    write(values, shape, dtype) {
        if (dtype === 'complex64' && values != null) {
            throw new Error(`Cannot write to a complex64 dtype. ` +
                `Please use tf.complex(real, imag).`);
        }
        const dataId = { id: this.nextDataId() };
        this.tensorMap.set(dataId, { dtype, shape, values, refCount: 1 });
        return dataId;
    }
    move(dataId, values, shape, dtype, refCount) {
        if (dtype === 'complex64') {
            throw new Error(`Cannot write to a complex64 dtype. ` +
                `Please use tf.complex(real, imag).`);
        }
        this.tensorMap.set(dataId, { dtype, shape, values, refCount });
    }
    submitQueue() {
        this.ensureComputePassEnded();
        this.queue.submit([this.currentCommandEncoder.finish()]);
        this.currentCommandEncoder = null;
        this.dispatchNumberInEncoder = 0;
        this.commandQueueOwnedIds = new WeakSet();
        this.tensorDataPendingDisposal.forEach(d => {
            this.releaseResource(d);
            this.tensorMap.delete(d);
        });
        this.uniformPendingDisposal.forEach(d => this.bufferManager.releaseBuffer(d.buffer, d.size, d.usage));
        this.stagingPendingDisposal.forEach(d => this.bufferManager.releaseUploadBuffer(d.buffer, d.size, d.usage));
        this.tensorDataPendingDisposal = [];
        this.uniformPendingDisposal = [];
        this.stagingPendingDisposal = [];
    }
    ensureCommandEncoderReady() {
        if (!this.currentCommandEncoder) {
            this.currentCommandEncoder = this.device.createCommandEncoder();
        }
    }
    ensureComputePassEnded() {
        if (this.currentComputePass) {
            this.currentComputePass.end();
            this.currentComputePass = null;
        }
    }
    getComputePass() {
        if (!this.currentComputePass) {
            this.currentComputePass = this.currentCommandEncoder.beginComputePass();
        }
        return this.currentComputePass;
    }
    async getBufferData(buffer, size) {
        const staging = this.bufferManager.acquireBuffer(size, GPUBufferUsage.COPY_DST | GPUBufferUsage.MAP_READ);
        this.ensureCommandEncoderReady();
        this.ensureComputePassEnded();
        this.currentCommandEncoder.copyBufferToBuffer(buffer, 0, staging, 0, size);
        this.submitQueue();
        await staging.mapAsync(GPUMapMode.READ);
        const values = staging.getMappedRange().slice(0);
        staging.unmap();
        if (staging != null) {
            this.bufferManager.releaseBuffer(staging, size, GPUBufferUsage.COPY_DST | GPUBufferUsage.MAP_READ);
        }
        // Need to get texture from swapChain to enable profiling tool
        // to capture a frame
        if (env().getBool('WEBGPU_USE_PROFILE_TOOL')) {
            util.assert(this.dummyContext !== undefined, () => `Fail to get context for profiling tool`);
            this.dummyContext.getCurrentTexture();
        }
        return values;
    }
    convertAndCacheOnCPU(dataId, data) {
        const tensorData = this.tensorMap.get(dataId);
        this.releaseResource(dataId);
        tensorData.values = data;
        return tensorData.values;
    }
    // TODO: Remove once this is fixed:
    // https://github.com/tensorflow/tfjs/issues/1595
    readSync(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        const { values } = tensorData;
        if (values == null) {
            throw new Error('WebGPU readSync is only available for CPU-resident tensors.');
        }
        return values;
    }
    async read(dataId) {
        if (!this.tensorMap.has(dataId)) {
            throw new Error(`Tensor ${dataId} was not registered!`);
        }
        const tensorData = this.tensorMap.get(dataId);
        const { values } = tensorData;
        if (values != null) {
            return this.convertAndCacheOnCPU(dataId, values);
        }
        // Download the values from the GPU.
        let vals;
        if (tensorData.dtype === 'complex64') {
            const ps = await Promise.all([
                this.read(tensorData.complexTensorInfos.real.dataId),
                this.read(tensorData.complexTensorInfos.imag.dataId)
            ]);
            const realValues = ps[0];
            const imagValues = ps[1];
            vals = backend_util.mergeRealAndImagArrays(realValues, imagValues);
        }
        else {
            const bufferInfo = tensorData.resourceInfo;
            const data = await this.getBufferData(bufferInfo.buffer, bufferInfo.size);
            vals = util.convertBackendValuesAndArrayBuffer(data, tensorData.dtype);
        }
        this.convertAndCacheOnCPU(dataId, vals);
        return vals;
    }
    // The source GPUBuffer and destination GPUBuffer have the same size and
    // usage.
    copyBuffer(srcBuffer, size, usage) {
        const dstBuffer = this.bufferManager.acquireBuffer(size, usage);
        this.ensureCommandEncoderReady();
        this.ensureComputePassEnded();
        this.currentCommandEncoder.copyBufferToBuffer(srcBuffer, 0, dstBuffer, 0, size);
        this.submitQueue();
        return dstBuffer;
    }
    /**
     * Create a TF.js tensor out of an existing WebGPU buffer.
     */
    createTensorFromGPUData(values, shape, dtype) {
        let buffer = values.buffer;
        if (dtype === 'complex64') {
            throw new Error(`Cannot write to a complex64 dtype. `);
        }
        const dataId = { id: this.nextDataId() };
        this.tensorMap.set(dataId, { dtype, shape, values: null, refCount: 1, external: values.zeroCopy });
        const tensorData = this.tensorMap.get(dataId);
        const size = webgpu_util.GPUBytesPerElement(tensorData.dtype) *
            util.sizeFromShape(tensorData.shape);
        if (values.buffer.size < size) {
            throw new Error(`GPUBuffer size(${values.buffer.size}) is smaller than tensor size(${size})!`);
        }
        else if ((values.buffer.usage &
            (GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC)) !==
            (GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC)) {
            throw new Error('GPUBuffer.usage should include GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC!');
        }
        // Do buffer copy by default.
        if (values.zeroCopy !== true) {
            buffer = this.copyBuffer(buffer, size, buffer.usage);
        }
        tensorData.resourceInfo = { size: buffer.size, usage: buffer.usage, buffer };
        return engine().makeTensorFromDataId(dataId, shape, dtype, this);
    }
    /**
     * Read tensor to a new GPUBuffer.
     * @param dataId The source tensor.
     */
    readToGPU(dataId) {
        const srcTensorData = this.tensorMap.get(dataId);
        const { values, dtype, shape, resourceInfo } = srcTensorData;
        if (dtype === 'complex64') {
            throw new Error('Does not support reading buffer for complex64 dtype.');
        }
        if (resourceInfo == null) {
            if (values != null) {
                throw new Error('Data is not on GPU but on CPU.');
            }
            else {
                throw new Error('There is no data on GPU or CPU.');
            }
        }
        const size = resourceInfo.size;
        const buffer = this.bufferManager.acquireBuffer(size, resourceInfo.usage);
        this.ensureCommandEncoderReady();
        this.ensureComputePassEnded();
        this.currentCommandEncoder.copyBufferToBuffer(resourceInfo.buffer, 0, buffer, 0, size);
        this.submitQueue();
        const tensorInfo = this.makeTensorInfo(shape, dtype);
        // Make engine track this tensor, so that we can dispose it later.
        const tensorRef = engine().makeTensorFromTensorInfo(tensorInfo);
        const tensorData = this.tensorMap.get(tensorInfo.dataId);
        tensorData
            .resourceInfo = { size, usage: this.defaultGpuBufferUsage(), buffer };
        return { tensorRef, buffer, bufSize: size };
    }
    bufferSync(t) {
        const data = this.readSync(t.dataId);
        if (t.dtype === 'string') {
            try {
                // Decode the bytes into string.
                const strings = data.map(d => util.decodeString(d));
                return buffer(t.shape, t.dtype, strings);
            }
            catch (_a) {
                throw new Error('Failed to decode encoded string bytes into utf-8');
            }
        }
        return buffer(t.shape, t.dtype, data);
    }
    async time(f) {
        if (!this.supportTimeQuery) {
            console.warn(`This device doesn't support timestamp-query-inside-passes extension. ` +
                `Start Chrome browser with flag ` +
                `--disable-dawn-features=disallow_unsafe_apis then try again. ` +
                `Otherwise, zero will be shown for the kernel time when profiling ` +
                `mode is enabled. Using performance.now is not workable for webgpu ` +
                `since it doesn't support synchronous data read from GPU.`);
        }
        const oldActiveTimers = this.activeTimers;
        const newActiveTimers = [];
        let outerMostTime = false;
        if (this.programTimersStack == null) {
            this.programTimersStack = newActiveTimers;
            outerMostTime = true;
        }
        else {
            this.activeTimers.push(newActiveTimers);
        }
        this.activeTimers = newActiveTimers;
        f();
        const flattenedActiveTimerQueries = util.flatten(this.activeTimers.map((d) => d.query))
            .filter(d => d != null);
        const flattenedActiveTimerNames = util.flatten(this.activeTimers.map((d) => d.name))
            .filter(d => d != null);
        this.activeTimers = oldActiveTimers;
        if (outerMostTime) {
            this.programTimersStack = null;
        }
        const res = {
            uploadWaitMs: this.uploadWaitMs,
            downloadWaitMs: this.downloadWaitMs,
            kernelMs: null,
            wallMs: null
        };
        const kernelMs = await Promise.all(flattenedActiveTimerQueries);
        res['kernelMs'] = util.sum(kernelMs);
        res['getExtraProfileInfo'] = () => kernelMs.map((d, i) => ({ name: flattenedActiveTimerNames[i], ms: d }))
            .map(d => `${d.name}: ${d.ms}`)
            .join(', ');
        this.uploadWaitMs = 0;
        this.downloadWaitMs = 0;
        return res;
    }
    makeTensorInfo(shape, dtype, values) {
        if (dtype === 'string' && values != null && values.length > 0 &&
            util.isString(values[0])) {
            values = values.map(d => util.encodeString(d));
        }
        const dataId = this.write(values, shape, dtype);
        return { dataId, shape, dtype };
    }
    tensorToBinding(tensor) {
        if (!tensor) {
            return null;
        }
        const tensorData = this.tensorMap.get(tensor.dataId);
        if ('texture' in tensorData.resourceInfo) {
            const info = tensorData.resourceInfo;
            if (info.texture instanceof GPUExternalTexture) {
                return info.texture;
            }
            else {
                return info.texture.createView();
            }
        }
        const bufferInfo = tensorData.resourceInfo;
        return { offset: 0, size: bufferInfo.size, buffer: bufferInfo.buffer };
    }
    async getQueryTime(query) {
        if (this.supportTimeQuery) {
            return this.getTimeFromQuerySet(query);
        }
        else {
            return 0;
        }
    }
    uploadToGPU(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        // Already on the GPU.
        if (tensorData.resourceInfo) {
            return;
        }
        const size = webgpu_util.GPUBytesPerElement(tensorData.dtype) *
            util.sizeFromShape(tensorData.shape);
        const buffer = this.bufferManager.acquireBuffer(size, this.defaultGpuBufferUsage());
        tensorData
            .resourceInfo = { size, usage: this.defaultGpuBufferUsage(), buffer };
        if (tensorData.values) {
            const stagingBuffer = this.bufferManager.acquireUploadBuffer(size, GPUBufferUsage.MAP_WRITE | GPUBufferUsage.COPY_SRC);
            const arrayBuffer = stagingBuffer.getMappedRange();
            if (tensorData.dtype === 'int32' || tensorData.dtype === 'bool') {
                new Int32Array(arrayBuffer).set(tensorData.values);
            }
            else {
                new Float32Array(arrayBuffer).set(tensorData.values);
            }
            stagingBuffer.unmap();
            this.ensureCommandEncoderReady();
            this.ensureComputePassEnded();
            this.currentCommandEncoder.copyBufferToBuffer(stagingBuffer, 0, buffer, 0, size);
            const stagingInfo = {
                size,
                usage: GPUBufferUsage.MAP_WRITE | GPUBufferUsage.COPY_SRC,
                buffer: stagingBuffer
            };
            this.stagingPendingDisposal.push(stagingInfo);
            // TODO: WebGPU doesn't support read data synchronously from GPU to CPU.
            // So it will report error when switching backend from WebGPU to others.
            // There are two situations: 1) swithcing the backend after running a
            // model; 2) swithcing the backend within the model. Temporarilly keep
            // the values on CPU to solve the first issue. tensorData.values = null;
        }
    }
    makeUniforms(programUniform) {
        let currentOffset = 0;
        let preLength = 0;
        const offsets = [];
        let maxAlignmentOfField = 1;
        programUniform.forEach((d) => {
            if (d.data.length === 0) {
                d.data = [1];
            }
            // https://www.w3.org/TR/WGSL/#alignof
            let baseAlignment;
            switch (d.data.length) {
                case 1:
                    baseAlignment = 4;
                    break;
                case 2:
                    baseAlignment = 8;
                    break;
                case 3:
                    baseAlignment = 16;
                    break;
                case 4:
                    baseAlignment = 16;
                    break;
                case 5:
                    baseAlignment = 16;
                    break;
                case 6:
                    baseAlignment = 16;
                    break;
                default:
                    util.assert(false, () => `Unsupported ${d.data.length}D shape`);
            }
            if (preLength === 5 || preLength === 6) {
                baseAlignment = 16;
            }
            if (baseAlignment > maxAlignmentOfField) {
                maxAlignmentOfField = baseAlignment;
            }
            currentOffset = Math.ceil(currentOffset / baseAlignment) * baseAlignment;
            preLength = d.data.length;
            offsets.push(currentOffset);
            currentOffset += d.data.length * 4;
        });
        currentOffset =
            Math.ceil(currentOffset / maxAlignmentOfField) * maxAlignmentOfField;
        const arrayBuffer = new ArrayBuffer(currentOffset);
        programUniform.forEach((d, i) => {
            const offset = offsets[i];
            if (d.type === 'int32') {
                new Int32Array(arrayBuffer, offset, d.data.length).set(d.data);
            }
            else if (d.type === 'uint32') {
                new Uint32Array(arrayBuffer, offset, d.data.length).set(d.data);
            }
            else {
                new Float32Array(arrayBuffer, offset, d.data.length).set(d.data);
            }
        });
        const uniformBuffer = this.bufferManager.acquireBuffer(currentOffset, GPUBufferUsage.COPY_DST | GPUBufferUsage.UNIFORM);
        this.queue.writeBuffer(uniformBuffer, 0, arrayBuffer, 0, currentOffset);
        const uniformInfo = {
            size: currentOffset,
            usage: GPUBufferUsage.COPY_DST | GPUBufferUsage.UNIFORM,
            buffer: uniformBuffer
        };
        this.uniformPendingDisposal.push(uniformInfo);
        return { offset: 0, size: currentOffset, buffer: uniformBuffer };
    }
    runWebGPUProgram(program, inputs, outputDtype, programDefinedUniform, output) {
        if (!output) {
            output = this.makeTensorInfo(program.outputShape, outputDtype);
        }
        if (util.sizeFromShape(output.shape) === 0) {
            // Short-circuit the computation since the result is empty (has 0 in its
            // shape).
            this.tensorMap.get(output.dataId).values =
                util.getTypedArrayFromDType(output.dtype, 0);
            return output;
        }
        this.uploadToGPU(output.dataId);
        program.dispatch = reshapeDispatch(this.device, program);
        // There are six kinds of uniforms: NAN, INFINITY, shapes, shape strides,
        // program size, program defined uniforms.
        let programUniform = [];
        let bufferShapes = [];
        if (!program.isFromPixels) {
            programUniform.push({ type: 'float32', data: [NaN] }, { type: 'float32', data: [Infinity] });
            bufferShapes = inputs.concat(output).map(d => d.shape);
            const uniformsType = 'int32';
            bufferShapes.map(d => {
                programUniform.push({ type: uniformsType, data: d });
            });
            const strides = util.computeStrides(output.shape);
            programUniform.push({ type: uniformsType, data: strides });
            if (program.size) {
                const size = util.sizeFromShape(program.outputShape);
                programUniform.push({ type: uniformsType, data: [program.isVec4 ? size / 4 : size] });
            }
        }
        const inputsData = inputs.map((input, i) => {
            if (input.dtype === 'complex64') {
                throw new Error(`GPGPUProgram does not support complex64 input. For complex64 ` +
                    `dtypes, please separate the program into real and imaginary ` +
                    `parts.`);
            }
            this.uploadToGPU(input.dataId);
            return {
                // Returning dtype from tensorMap because it reflects dtype
                // of underlying buffer, rather than abstract dtype.
                dtype: this.tensorMap.get(input.dataId).dtype,
                shape: input.shape,
                name: program.variableNames[i]
            };
        });
        const key = webgpu_program.makeShaderKey(program, bufferShapes, inputsData, output);
        let pipeline;
        if (key in this.pipelineCache) {
            pipeline = this.pipelineCache[key];
        }
        else {
            pipeline = webgpu_program.compileProgram(this.device, program, inputsData, output);
            this.pipelineCache[key] = pipeline;
        }
        if (programDefinedUniform) {
            programUniform = [...programUniform, ...programDefinedUniform];
        }
        const bindings = [
            this.tensorToBinding(output), ...inputs.map(t => this.tensorToBinding(t)),
            this.makeUniforms(programUniform)
        ];
        const bindGroup = this.device.createBindGroup({
            layout: pipeline.getBindGroupLayout(0),
            entries: bindings.map((b, i) => ({ binding: i, resource: b })),
        });
        this.ensureCommandEncoderReady();
        const pass = this.getComputePass();
        const shouldTimeProgram = this.activeTimers != null;
        if (shouldTimeProgram) {
            if (this.supportTimeQuery) {
                // tslint:disable-next-line:no-any
                pass.writeTimestamp(this.querySet, 0);
            }
        }
        pass.setPipeline(pipeline);
        pass.setBindGroup(0, bindGroup);
        pass.dispatchWorkgroups(program.dispatch[0], program.dispatch[1], program.dispatch[2]);
        if (shouldTimeProgram) {
            if (this.supportTimeQuery) {
                // tslint:disable-next-line:no-any
                pass.writeTimestamp(this.querySet, 1);
            }
        }
        this.dispatchNumberInEncoder++;
        inputs.forEach(input => {
            this.commandQueueOwnedIds.add(input.dataId);
        });
        this.commandQueueOwnedIds.add(output.dataId);
        if (env().get('WEBGPU_DEFERRED_SUBMIT_BATCH_SIZE') <= this.dispatchNumberInEncoder) {
            this.submitQueue();
        }
        if (shouldTimeProgram) {
            this.activeTimers.push({
                name: program.constructor.name,
                query: this.getQueryTime(this.querySet)
            });
        }
        return output;
    }
    async getTimeFromQuerySet(querySet) {
        const queryBuffer = this.bufferManager.acquireBuffer(16, GPUBufferUsage.COPY_SRC | GPUBufferUsage.QUERY_RESOLVE);
        const dst = this.bufferManager.acquireBuffer(16, GPUBufferUsage.MAP_READ | GPUBufferUsage.COPY_DST);
        this.ensureCommandEncoderReady();
        this.ensureComputePassEnded();
        this.currentCommandEncoder.resolveQuerySet(querySet, 0, 2, queryBuffer, 0);
        this.currentCommandEncoder.copyBufferToBuffer(queryBuffer, 0, dst, 0, 16);
        this.submitQueue();
        await dst.mapAsync(GPUMapMode.READ);
        const arrayBuf = new BigUint64Array(dst.getMappedRange());
        const timeElapsedNanos = Number((arrayBuf[1] - arrayBuf[0]));
        dst.unmap();
        this.bufferManager.releaseBuffer(dst, 16, GPUBufferUsage.MAP_READ | GPUBufferUsage.COPY_DST);
        this.bufferManager.releaseBuffer(queryBuffer, 16, GPUBufferUsage.COPY_SRC | GPUBufferUsage.QUERY_RESOLVE);
        // Return milliseconds.
        return timeElapsedNanos / 1000000;
    }
    shouldExecuteOnCPU(inputs, sizeThreshold = CPU_HANDOFF_SIZE_THRESHOLD) {
        return env().getBool('WEBGPU_CPU_FORWARD') &&
            inputs.every(input => this.tensorMap.get(input.dataId).resourceInfo == null &&
                util.sizeFromShape(input.shape) < sizeThreshold);
    }
    numDataIds() {
        return this.tensorMap.numDataIds() - this.tensorDataPendingDisposal.length;
    }
    dispose() {
        if (this.disposed) {
            return;
        }
        this.bufferManager.dispose();
        this.textureManager.dispose();
        this.disposed = true;
    }
}
WebGPUBackend.nextDataId = 0;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2VuZF93ZWJncHUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi90ZmpzLWJhY2tlbmQtd2ViZ3B1L3NyYy9iYWNrZW5kX3dlYmdwdS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFFSCxPQUFPLGdCQUFnQixDQUFDO0FBRXhCLE9BQU8sRUFBQyxZQUFZLEVBQWlCLE1BQU0sRUFBRSxXQUFXLEVBQVksTUFBTSxFQUFFLEdBQUcsRUFBVyxhQUFhLEVBQTRGLElBQUksRUFBYSxNQUFNLHVCQUF1QixDQUFDO0FBRWxQLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sa0JBQWtCLENBQUM7QUFDL0MsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQ2pELE9BQU8sS0FBSyxjQUFjLE1BQU0sa0JBQWtCLENBQUM7QUFDbkQsT0FBTyxLQUFLLFdBQVcsTUFBTSxlQUFlLENBQUM7QUFvRDdDLCtFQUErRTtBQUMvRSw0QkFBNEI7QUFDNUIsTUFBTSwwQkFBMEIsR0FDNUIsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7QUFFekQsaURBQWlEO0FBQ2pELE1BQU0sZUFBZSxHQUNqQixDQUFDLE1BQWlCLEVBQ2pCLE9BQXFDLEVBQTRCLEVBQUU7SUFDbEUsTUFBTSx1Q0FBdUMsR0FDekMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxnQ0FBZ0MsQ0FBQztJQUNuRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUN6QyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDckMsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksdUNBQXVDLENBQUMsRUFBRTtR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QWEsQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFFUSxVQUFVO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLEVBQUUsR0FBRyxJQUFJLENBQUMseUJBQXlCLENBQUMsTUFBTSxDQUFDO0lBQzdFLENBQUM7SUFFUSxPQUFPO1FBQ2QsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2pCLE9BQU87U0FDUjtRQUNELElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztJQUN2QixDQUFDOztBQXB4QmMsd0JBQVUsR0FBRyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBHb29nbGUgTExDLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICovXG5cbmltcG9ydCAnLi9mbGFnc193ZWJncHUnO1xuXG5pbXBvcnQge2JhY2tlbmRfdXRpbCwgQmFja2VuZFZhbHVlcywgYnVmZmVyLCBEYXRhU3RvcmFnZSwgRGF0YVR5cGUsIGVuZ2luZSwgZW52LCBHUFVEYXRhLCBLZXJuZWxCYWNrZW5kLCBSYW5rLCBSZWN1cnNpdmVBcnJheSwgU2hhcGVNYXAsIFRlbnNvciwgVGVuc29yQnVmZmVyLCBUZW5zb3JJbmZvLCBUaW1pbmdJbmZvLCBUeXBlZEFycmF5LCB1dGlsLCBXZWJHUFVEYXRhfSBmcm9tICdAdGVuc29yZmxvdy90ZmpzLWNvcmUnO1xuXG5pbXBvcnQge0FkYXB0ZXJJbmZvfSBmcm9tICcuL2FkYXB0ZXJfaW5mbyc7XG5pbXBvcnQge0J1ZmZlck1hbmFnZXJ9IGZyb20gJy4vYnVmZmVyX21hbmFnZXInO1xuaW1wb3J0IHtUZXh0dXJlTWFuYWdlcn0gZnJvbSAnLi90ZXh0dXJlX21hbmFnZXInO1xuaW1wb3J0ICogYXMgd2ViZ3B1X3Byb2dyYW0gZnJvbSAnLi93ZWJncHVfcHJvZ3JhbSc7XG5pbXBvcnQgKiBhcyB3ZWJncHVfdXRpbCBmcm9tICcuL3dlYmdwdV91dGlsJztcblxuZXhwb3J0IGludGVyZmFjZSBXZWJHUFVNZW1vcnlJbmZvIGV4dGVuZHMgYmFja2VuZF91dGlsLk1lbW9yeUluZm8ge1xuICBudW1CeXRlc0luR1BVOiBudW1iZXI7XG4gIG51bUJ5dGVzQWxsb2NhdGVkSW5HUFU6IG51bWJlcjtcbiAgdW5yZWxpYWJsZTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IHR5cGUgQnVmZmVySW5mbyA9IHtcbiAgc2l6ZTogbnVtYmVyLFxuICB1c2FnZTogR1BVQnVmZmVyVXNhZ2VGbGFncyxcbiAgYnVmZmVyOiBHUFVCdWZmZXJcbn07XG5cbmV4cG9ydCB0eXBlIFRleHR1cmVJbmZvID0ge1xuICB3aWR0aDogbnVtYmVyLFxuICBoZWlnaHQ6IG51bWJlcixcbiAgZm9ybWF0OiBHUFVUZXh0dXJlRm9ybWF0LFxuICB1c2FnZTogR1BVVGV4dHVyZVVzYWdlRmxhZ3MsXG4gIHRleHR1cmU6IEdQVVRleHR1cmV8R1BVRXh0ZXJuYWxUZXh0dXJlXG59O1xuXG50eXBlIFRlbnNvckRhdGEgPSB7XG4gIHZhbHVlczogQmFja2VuZFZhbHVlcyxcbiAgZHR5cGU6IERhdGFUeXBlLFxuICBzaGFwZTogbnVtYmVyW10sXG4gIHJlZkNvdW50OiBudW1iZXIsXG4gIHJlc291cmNlSW5mbz86IEJ1ZmZlckluZm98VGV4dHVyZUluZm8sXG4gIC8vIGV4dGVybmFsIGlzIHRydWUgbWVhbnMgd2UgdXNlIHRoZSByZXNvdXJjZSBwcm92aWRlZCBieSB1c2VycyBkaXJlY3RseVxuICAvLyAod2l0aG91dCBhIGNvcHkpLCBzbyB1c2VycyBzaG91bGQgYmUgcmVzcG9uc2libGUgZm9yIGl0cyByZWxlYXNlLlxuICBleHRlcm5hbD86IGJvb2xlYW4sXG4gIC8vIEZvciBjb21wbGV4IG51bWJlcnMsIHRoZSByZWFsIGFuZCBpbWFnaW5hcnkgcGFydHMgYXJlIHN0b3JlZCBhcyB0aGVpciBvd25cbiAgLy8gaW5kaXZpZHVhbCB0ZW5zb3JzLCB3aXRoIGEgcGFyZW50IGpvaW5pbmcgdGhlIHR3byB3aXRoIHRoZVxuICAvLyBjb21wbGV4VGVuc29ySW5mb3MgZmllbGQuXG4gIGNvbXBsZXhUZW5zb3JJbmZvcz86IHtyZWFsOiBUZW5zb3JJbmZvLCBpbWFnOiBUZW5zb3JJbmZvfVxufTtcblxuaW50ZXJmYWNlIERhdGFJZCB7fVxuXG5leHBvcnQgdHlwZSBXZWJHUFVLZXJuZWxJbmZvID0ge1xuICBuYW1lOiBzdHJpbmc7IHF1ZXJ5OiBQcm9taXNlPG51bWJlcj47XG59O1xuXG5leHBvcnQgdHlwZSBUaW1lck5vZGUgPSBSZWN1cnNpdmVBcnJheTxXZWJHUFVLZXJuZWxJbmZvPnxXZWJHUFVLZXJuZWxJbmZvO1xuXG5leHBvcnQgaW50ZXJmYWNlIFdlYkdQVVRpbWluZ0luZm8gZXh0ZW5kcyBUaW1pbmdJbmZvIHtcbiAgdXBsb2FkV2FpdE1zOiBudW1iZXI7XG4gIGRvd25sb2FkV2FpdE1zOiBudW1iZXI7XG59XG5cbnR5cGUgUHJvZ3JhbVVuaWZvcm0gPSBBcnJheTx7dHlwZTogc3RyaW5nOyBkYXRhOiBudW1iZXJbXX0+O1xuXG4vLyBFbXBpcmljYWxseSBkZXRlcm1pbmVkIGNvbnN0YW50IHVzZWQgdG8gZGV0ZXJtaW5lIHNpemUgdGhyZXNob2xkIGZvciBoYW5kaW5nXG4vLyBvZmYgZXhlY3V0aW9uIHRvIHRoZSBDUFUuXG5jb25zdCBDUFVfSEFORE9GRl9TSVpFX1RIUkVTSE9MRCA9XG4gICAgZW52KCkuZ2V0TnVtYmVyKCdXRUJHUFVfQ1BVX0hBTkRPRkZfU0laRV9USFJFU0hPTEQnKTtcblxuLy8gUmVzaGFwZSBkaXNwYXRjaCwgbm90IHRvIGV4Y2VlZCBkZXZpY2UgbGltaXRzLlxuY29uc3QgcmVzaGFwZURpc3BhdGNoID1cbiAgICAoZGV2aWNlOiBHUFVEZXZpY2UsXG4gICAgIHByb2dyYW06IHdlYmdwdV9wcm9ncmFtLldlYkdQVVByb2dyYW0pOiBbbnVtYmVyLCBudW1iZXIsIG51bWJlcl0gPT4ge1xuICAgICAgY29uc3QgTUFYX0NPTVBVVEVfUEVSX0RJTUVOU0lPTl9ESVNQQVRDSF9TSVpFID1cbiAgICAgICAgICBkZXZpY2UubGltaXRzLm1heENvbXB1dGVXb3JrZ3JvdXBzUGVyRGltZW5zaW9uO1xuICAgICAgY29uc3QgbGF5b3V0ID0gcHJvZ3JhbVsnZGlzcGF0Y2hMYXlvdXQnXTtcbiAgICAgIGNvbnN0IGRpc3BhdGNoID0gcHJvZ3JhbVsnZGlzcGF0Y2gnXTtcbiAgICAgIGlmIChkaXNwYXRjaC5ldmVyeSgoZCkgPT4gZCA8PSBNQVhfQ09NUFVURV9QRVJfRElNRU5TSU9OX0RJU1BBVENIX1NJWkUpKSB7XG4gICAgICAgIHJldHVybiBkaXNwYXRjaDtcbiAgICAgIH1cblxuICAgICAgdXRpbC5hc3NlcnQoXG4gICAgICAgICAgZGlzcGF0Y2hbMF0gPiBNQVhfQ09NUFVURV9QRVJfRElNRU5TSU9OX0RJU1BBVENIX1NJWkUgJiZcbiAgICAgICAgICAgICAgbGF5b3V0LnkgPT09IHVuZGVmaW5lZCAmJiBsYXlvdXQueiA9PT0gdW5kZWZpbmVkLFxuICAgICAgICAgICgpID0+ICdEaXNwYXRjaCBzaXplIGV4Y2VlZHMgV2ViR1BVIGxpbWl0cyBpbiBZIG9yIFogZGltZW5zaW9uLicpO1xuXG4gICAgICBsZXQgZGlzcGF0Y2hBdmVyYWdlID0gTWF0aC5jZWlsKE1hdGguc3FydChkaXNwYXRjaFswXSkpO1xuICAgICAgaWYgKGRpc3BhdGNoQXZlcmFnZSA+IE1BWF9DT01QVVRFX1BFUl9ESU1FTlNJT05fRElTUEFUQ0hfU0laRSkge1xuICAgICAgICBkaXNwYXRjaEF2ZXJhZ2UgPSBNYXRoLmNlaWwoTWF0aC5jYnJ0KGRpc3BhdGNoWzBdKSk7XG4gICAgICAgIHV0aWwuYXNzZXJ0KFxuICAgICAgICAgICAgZGlzcGF0Y2hBdmVyYWdlIDw9IE1BWF9DT01QVVRFX1BFUl9ESU1FTlNJT05fRElTUEFUQ0hfU0laRSxcbiAgICAgICAgICAgICgpID0+ICdUb3RhbCBkaXNwYXRjaCBzaXplIGV4Y2VlZHMgV2ViR1BVIG1heGltdW0uJyk7XG4gICAgICAgIHJldHVybiBbZGlzcGF0Y2hBdmVyYWdlLCBkaXNwYXRjaEF2ZXJhZ2UsIGRpc3BhdGNoQXZlcmFnZV07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gW2Rpc3BhdGNoQXZlcmFnZSwgZGlzcGF0Y2hBdmVyYWdlLCAxXTtcbiAgICAgIH1cbiAgICB9O1xuXG5leHBvcnQgY2xhc3MgV2ViR1BVQmFja2VuZCBleHRlbmRzIEtlcm5lbEJhY2tlbmQge1xuICBidWZmZXJNYW5hZ2VyOiBCdWZmZXJNYW5hZ2VyO1xuICBhZGFwdGVySW5mbzogQWRhcHRlckluZm87XG4gIGRldmljZTogR1BVRGV2aWNlO1xuICBxdWV1ZTogR1BVUXVldWU7XG4gIHRlbnNvck1hcDogRGF0YVN0b3JhZ2U8VGVuc29yRGF0YT47XG4gIHRleHR1cmVNYW5hZ2VyOiBUZXh0dXJlTWFuYWdlcjtcbiAgdGhyZXNob2xkVG9JbmNyZWFzZVdvcmtncm91cHM6IG51bWJlcjtcblxuICBwcml2YXRlIGFjdGl2ZVRpbWVyczogVGltZXJOb2RlW107XG4gIHByaXZhdGUgY3VycmVudENvbW1hbmRFbmNvZGVyOiBHUFVDb21tYW5kRW5jb2RlcjtcbiAgcHJpdmF0ZSBjdXJyZW50Q29tcHV0ZVBhc3M6IEdQVUNvbXB1dGVQYXNzRW5jb2RlcjtcbiAgcHJpdmF0ZSBjb21tYW5kUXVldWVPd25lZElkcyA9IG5ldyBXZWFrU2V0PERhdGFJZD4oKTtcbiAgcHJpdmF0ZSBkaXNwYXRjaE51bWJlckluRW5jb2RlciA9IDA7XG4gIHByaXZhdGUgZGlzcG9zZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBkb3dubG9hZFdhaXRNcyA9IDA7XG4gIHByaXZhdGUgZHVtbXlDYW52YXM6IEhUTUxDYW52YXNFbGVtZW50O1xuICBwcml2YXRlIGR1bW15Q29udGV4dDogR1BVQ2FudmFzQ29udGV4dDtcbiAgcHJpdmF0ZSB0ZW5zb3JEYXRhUGVuZGluZ0Rpc3Bvc2FsOiBEYXRhSWRbXSA9IFtdO1xuICBwcml2YXRlIHN0YXRpYyBuZXh0RGF0YUlkID0gMDtcbiAgcHJpdmF0ZSBwaXBlbGluZUNhY2hlOiB7W2tleTogc3RyaW5nXTogR1BVQ29tcHV0ZVBpcGVsaW5lfTtcbiAgcHJpdmF0ZSBwcm9ncmFtVGltZXJzU3RhY2s6IFRpbWVyTm9kZVtdO1xuICBwcml2YXRlIHF1ZXJ5U2V0OiBHUFVRdWVyeVNldDtcbiAgcHJpdmF0ZSBzdGFnaW5nUGVuZGluZ0Rpc3Bvc2FsOiBCdWZmZXJJbmZvW10gPSBbXTtcbiAgcHJpdmF0ZSBzdXBwb3J0VGltZVF1ZXJ5OiBib29sZWFuO1xuICBwcml2YXRlIHVuaWZvcm1QZW5kaW5nRGlzcG9zYWw6IEJ1ZmZlckluZm9bXSA9IFtdO1xuICBwcml2YXRlIHVwbG9hZFdhaXRNcyA9IDA7XG5cbiAgcHJpdmF0ZSBuZXh0RGF0YUlkKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIFdlYkdQVUJhY2tlbmQubmV4dERhdGFJZCsrO1xuICB9XG5cbiAgY29uc3RydWN0b3IoZGV2aWNlOiBHUFVEZXZpY2UsIGFkYXB0ZXJJbmZvPzogR1BVQWRhcHRlckluZm8pIHtcbiAgICBzdXBlcigpO1xuICAgIGlmICghd2ViZ3B1X3V0aWwuaXNXZWJHUFVTdXBwb3J0ZWQoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdXZWJHUFUgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGlzIGRldmljZScpO1xuICAgIH1cbiAgICB0aGlzLnBpcGVsaW5lQ2FjaGUgPSB7fTtcbiAgICB0aGlzLmRldmljZSA9IGRldmljZTtcbiAgICB0aGlzLnF1ZXVlID0gZGV2aWNlLnF1ZXVlO1xuICAgIHRoaXMuY3VycmVudENvbW1hbmRFbmNvZGVyID0gbnVsbDtcbiAgICB0aGlzLmN1cnJlbnRDb21wdXRlUGFzcyA9IG51bGw7XG4gICAgdGhpcy5zdXBwb3J0VGltZVF1ZXJ5ID1cbiAgICAgICAgZGV2aWNlLmZlYXR1cmVzLmhhcygndGltZXN0YW1wLXF1ZXJ5LWluc2lkZS1wYXNzZXMnKTtcbiAgICB0aGlzLmFkYXB0ZXJJbmZvID0gbmV3IEFkYXB0ZXJJbmZvKGFkYXB0ZXJJbmZvKTtcbiAgICB0aGlzLnRocmVzaG9sZFRvSW5jcmVhc2VXb3JrZ3JvdXBzID1cbiAgICAgICAgdGhpcy5hZGFwdGVySW5mby5pbnRlbEdQVUdlbmVyYXRpb24gPj0gMTIgPyAxNiA6IDg7XG5cbiAgICB0aGlzLmJ1ZmZlck1hbmFnZXIgPSBuZXcgQnVmZmVyTWFuYWdlcih0aGlzLmRldmljZSk7XG4gICAgdGhpcy50ZXh0dXJlTWFuYWdlciA9IG5ldyBUZXh0dXJlTWFuYWdlcih0aGlzLmRldmljZSk7XG4gICAgdGhpcy50ZW5zb3JNYXAgPSBuZXcgRGF0YVN0b3JhZ2UodGhpcywgZW5naW5lKCkpO1xuICAgIGlmICh0aGlzLnN1cHBvcnRUaW1lUXVlcnkpIHtcbiAgICAgIHRoaXMucXVlcnlTZXQgPSB0aGlzLmRldmljZS5jcmVhdGVRdWVyeVNldCh7XG4gICAgICAgIHR5cGU6ICd0aW1lc3RhbXAnLFxuICAgICAgICBjb3VudDogMixcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFByb2ZpbGluZyB0b29scyBsaWtlIFBJWCBuZWVkcyB0aGlzIGR1bW15IGNhbnZhcyB0b1xuICAgIC8vIHRyaWdnZXIgY2FwdHVyaW5nIGEgZnJhbWUuXG4gICAgaWYgKGVudigpLmdldEJvb2woJ1dFQkdQVV9VU0VfUFJPRklMRV9UT09MJykpIHtcbiAgICAgIHRoaXMuZHVtbXlDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgIHRoaXMuZHVtbXlDYW52YXMud2lkdGggPSAxO1xuICAgICAgdGhpcy5kdW1teUNhbnZhcy5oZWlnaHQgPSAxO1xuXG4gICAgICB0aGlzLmR1bW15Q29udGV4dCA9IHRoaXMuZHVtbXlDYW52YXMuZ2V0Q29udGV4dCgnd2ViZ3B1Jyk7XG4gICAgICB0aGlzLmR1bW15Q29udGV4dC5jb25maWd1cmUoe1xuICAgICAgICBkZXZpY2UsXG4gICAgICAgIGZvcm1hdDogJ2JncmE4dW5vcm0nLFxuICAgICAgfSk7XG5cbiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5kdW1teUNhbnZhcyk7XG4gICAgfVxuICB9XG5cbiAgb3ZlcnJpZGUgZmxvYXRQcmVjaXNpb24oKTogMzIge1xuICAgIHJldHVybiAzMjtcbiAgfVxuXG4gIGRlZmF1bHRHcHVCdWZmZXJVc2FnZSgpOiBudW1iZXIge1xuICAgIHJldHVybiBHUFVCdWZmZXJVc2FnZS5TVE9SQUdFIHwgR1BVQnVmZmVyVXNhZ2UuQ09QWV9TUkMgfFxuICAgICAgICBHUFVCdWZmZXJVc2FnZS5DT1BZX0RTVDtcbiAgfVxuXG4gIC8qKlxuICAgKiBEaXNwb3NlIHRoZSBtZW1vcnkgaWYgdGhlIGRhdGFJZCBoYXMgMCByZWZDb3VudC4gUmV0dXJuIHRydWUgaWYgdGhlIG1lbW9yeVxuICAgKiBpcyByZWxlYXNlZCBvciBtZW1vcnkgaXMgbm90IG1hbmFnZWQgaW4gdGhpcyBiYWNrZW5kLCBmYWxzZSBpZiBtZW1vcnkgaXNcbiAgICogbm90IGNsZWFyZWQuXG4gICAqIEBwYXJhbSBkYXRhSWRcbiAgICogQG9hcmFtIGZvcmNlIE9wdGlvbmFsLCByZW1vdmUgdGhlIGRhdGEgcmVnYXJkbGVzcyBvZiByZWZDb3VudFxuICAgKi9cbiAgb3ZlcnJpZGUgZGlzcG9zZURhdGEoZGF0YUlkOiBEYXRhSWQsIGZvcmNlID0gZmFsc2UpOiBib29sZWFuIHtcbiAgICBpZiAodGhpcy50ZW5zb3JEYXRhUGVuZGluZ0Rpc3Bvc2FsLmluZGV4T2YoZGF0YUlkKSA+PSAwKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmICghdGhpcy50ZW5zb3JNYXAuaGFzKGRhdGFJZCkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGNvbnN0IHRlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICB0aGlzLmRlY1JlZihkYXRhSWQpO1xuICAgIGlmICghZm9yY2UgJiYgdGVuc29yRGF0YS5yZWZDb3VudCA+IDApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBjb21wbGV4IGlzIG5ldmVyIGluIGNvbW1hbmRRdWV1ZU93bmVkSWRzXG4gICAgaWYgKHRoaXMuY29tbWFuZFF1ZXVlT3duZWRJZHMuaGFzKGRhdGFJZCkpIHtcbiAgICAgIHRoaXMudGVuc29yRGF0YVBlbmRpbmdEaXNwb3NhbC5wdXNoKGRhdGFJZCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3Qge2NvbXBsZXhUZW5zb3JJbmZvc30gPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICBpZiAoY29tcGxleFRlbnNvckluZm9zICE9IG51bGwpIHtcbiAgICAgIHRoaXMuZGlzcG9zZURhdGEoY29tcGxleFRlbnNvckluZm9zLnJlYWwuZGF0YUlkLCBmb3JjZSk7XG4gICAgICB0aGlzLmRpc3Bvc2VEYXRhKGNvbXBsZXhUZW5zb3JJbmZvcy5pbWFnLmRhdGFJZCwgZm9yY2UpO1xuICAgIH1cblxuICAgIHRoaXMucmVsZWFzZVJlc291cmNlKGRhdGFJZCk7XG4gICAgdGhpcy50ZW5zb3JNYXAuZGVsZXRlKGRhdGFJZCk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIG92ZXJyaWRlIG1lbW9yeSgpOiBXZWJHUFVNZW1vcnlJbmZvIHtcbiAgICByZXR1cm4ge1xuICAgICAgbnVtQnl0ZXNJbkdQVTogdGhpcy5idWZmZXJNYW5hZ2VyLm51bUJ5dGVzVXNlZCxcbiAgICAgIG51bUJ5dGVzQWxsb2NhdGVkSW5HUFU6IHRoaXMuYnVmZmVyTWFuYWdlci5udW1CeXRlc0FsbG9jYXRlZCxcbiAgICAgIHVucmVsaWFibGU6IGZhbHNlXG4gICAgfSBhcyBXZWJHUFVNZW1vcnlJbmZvO1xuICB9XG5cbiAgcmVsZWFzZVJlc291cmNlKGRhdGFJZDogRGF0YUlkKSB7XG4gICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuICAgIGlmICghdGVuc29yRGF0YSB8fCAhdGVuc29yRGF0YS5yZXNvdXJjZUluZm8pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gSWYgdGVuc29yJ3MgcmVzb3VyY2UgaXMgZnJvbSBleHRlcm5hbCwgZG8gbm90IHJlbGVhc2UuXG4gICAgaWYgKHRlbnNvckRhdGEuZXh0ZXJuYWwpIHtcbiAgICAgIHRlbnNvckRhdGEucmVzb3VyY2VJbmZvID0gbnVsbDtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCd0ZXh0dXJlJyBpbiB0ZW5zb3JEYXRhLnJlc291cmNlSW5mbykge1xuICAgICAgY29uc3QgdGV4dHVyZUluZm8gPSB0ZW5zb3JEYXRhLnJlc291cmNlSW5mbztcbiAgICAgIGlmICh0ZXh0dXJlSW5mby50ZXh0dXJlIGluc3RhbmNlb2YgR1BVVGV4dHVyZSkge1xuICAgICAgICB0aGlzLnRleHR1cmVNYW5hZ2VyLnJlbGVhc2VUZXh0dXJlKFxuICAgICAgICAgICAgdGV4dHVyZUluZm8udGV4dHVyZSwgdGV4dHVyZUluZm8ud2lkdGgsIHRleHR1cmVJbmZvLmhlaWdodCxcbiAgICAgICAgICAgIHRleHR1cmVJbmZvLmZvcm1hdCwgdGV4dHVyZUluZm8udXNhZ2UpO1xuICAgICAgfVxuICAgICAgdGV4dHVyZUluZm8udGV4dHVyZSA9IG51bGw7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGJ1ZmZlckluZm8gPSB0ZW5zb3JEYXRhLnJlc291cmNlSW5mbztcbiAgICAgIHRoaXMuYnVmZmVyTWFuYWdlci5yZWxlYXNlQnVmZmVyKFxuICAgICAgICAgIGJ1ZmZlckluZm8uYnVmZmVyLCBidWZmZXJJbmZvLnNpemUsIGJ1ZmZlckluZm8udXNhZ2UpO1xuICAgICAgYnVmZmVySW5mby5idWZmZXIgPSBudWxsO1xuICAgIH1cbiAgICB0ZW5zb3JEYXRhLnJlc291cmNlSW5mbyA9IG51bGw7XG4gIH1cblxuICAvKiogUmV0dXJuIHJlZkNvdW50IG9mIGEgYFRlbnNvckRhdGFgLiAqL1xuICBvdmVycmlkZSByZWZDb3VudChkYXRhSWQ6IERhdGFJZCk6IG51bWJlciB7XG4gICAgaWYgKHRoaXMudGVuc29yTWFwLmhhcyhkYXRhSWQpKSB7XG4gICAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KGRhdGFJZCk7XG4gICAgICByZXR1cm4gdGVuc29yRGF0YS5yZWZDb3VudDtcbiAgICB9XG4gICAgcmV0dXJuIDA7XG4gIH1cblxuICAvKiogSW5jcmVhc2UgcmVmQ291bnQgb2YgYSBgVGVuc29yRGF0YWAuICovXG4gIG92ZXJyaWRlIGluY1JlZihkYXRhSWQ6IERhdGFJZCk6IHZvaWQge1xuICAgIGNvbnN0IHRlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICB0ZW5zb3JEYXRhLnJlZkNvdW50Kys7XG4gIH1cblxuICAvKiogRGVjcmVhc2UgcmVmQ291bnQgb2YgYSBgVGVuc29yRGF0YWAuICovXG4gIGRlY1JlZihkYXRhSWQ6IERhdGFJZCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnRlbnNvck1hcC5oYXMoZGF0YUlkKSkge1xuICAgICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuICAgICAgdGVuc29yRGF0YS5yZWZDb3VudC0tO1xuICAgIH1cbiAgfVxuXG4gIG92ZXJyaWRlIHdyaXRlKHZhbHVlczogQmFja2VuZFZhbHVlcywgc2hhcGU6IG51bWJlcltdLCBkdHlwZTogRGF0YVR5cGUpOlxuICAgICAgRGF0YUlkIHtcbiAgICBpZiAoZHR5cGUgPT09ICdjb21wbGV4NjQnICYmIHZhbHVlcyAhPSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCB3cml0ZSB0byBhIGNvbXBsZXg2NCBkdHlwZS4gYCArXG4gICAgICAgICAgYFBsZWFzZSB1c2UgdGYuY29tcGxleChyZWFsLCBpbWFnKS5gKTtcbiAgICB9XG4gICAgY29uc3QgZGF0YUlkID0ge2lkOiB0aGlzLm5leHREYXRhSWQoKX07XG4gICAgdGhpcy50ZW5zb3JNYXAuc2V0KGRhdGFJZCwge2R0eXBlLCBzaGFwZSwgdmFsdWVzLCByZWZDb3VudDogMX0pO1xuICAgIHJldHVybiBkYXRhSWQ7XG4gIH1cblxuICBvdmVycmlkZSBtb3ZlKFxuICAgICAgZGF0YUlkOiBEYXRhSWQsIHZhbHVlczogQmFja2VuZFZhbHVlcywgc2hhcGU6IG51bWJlcltdLCBkdHlwZTogRGF0YVR5cGUsXG4gICAgICByZWZDb3VudDogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKGR0eXBlID09PSAnY29tcGxleDY0Jykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3Qgd3JpdGUgdG8gYSBjb21wbGV4NjQgZHR5cGUuIGAgK1xuICAgICAgICAgIGBQbGVhc2UgdXNlIHRmLmNvbXBsZXgocmVhbCwgaW1hZykuYCk7XG4gICAgfVxuICAgIHRoaXMudGVuc29yTWFwLnNldChkYXRhSWQsIHtkdHlwZSwgc2hhcGUsIHZhbHVlcywgcmVmQ291bnR9KTtcbiAgfVxuXG4gIHN1Ym1pdFF1ZXVlKCkge1xuICAgIHRoaXMuZW5zdXJlQ29tcHV0ZVBhc3NFbmRlZCgpO1xuICAgIHRoaXMucXVldWUuc3VibWl0KFt0aGlzLmN1cnJlbnRDb21tYW5kRW5jb2Rlci5maW5pc2goKV0pO1xuICAgIHRoaXMuY3VycmVudENvbW1hbmRFbmNvZGVyID0gbnVsbDtcbiAgICB0aGlzLmRpc3BhdGNoTnVtYmVySW5FbmNvZGVyID0gMDtcblxuICAgIHRoaXMuY29tbWFuZFF1ZXVlT3duZWRJZHMgPSBuZXcgV2Vha1NldDxEYXRhSWQ+KCk7XG5cbiAgICB0aGlzLnRlbnNvckRhdGFQZW5kaW5nRGlzcG9zYWwuZm9yRWFjaChkID0+IHtcbiAgICAgIHRoaXMucmVsZWFzZVJlc291cmNlKGQpO1xuICAgICAgdGhpcy50ZW5zb3JNYXAuZGVsZXRlKGQpO1xuICAgIH0pO1xuICAgIHRoaXMudW5pZm9ybVBlbmRpbmdEaXNwb3NhbC5mb3JFYWNoKFxuICAgICAgICBkID0+IHRoaXMuYnVmZmVyTWFuYWdlci5yZWxlYXNlQnVmZmVyKGQuYnVmZmVyLCBkLnNpemUsIGQudXNhZ2UpKTtcbiAgICB0aGlzLnN0YWdpbmdQZW5kaW5nRGlzcG9zYWwuZm9yRWFjaChcbiAgICAgICAgZCA9PiB0aGlzLmJ1ZmZlck1hbmFnZXIucmVsZWFzZVVwbG9hZEJ1ZmZlcihkLmJ1ZmZlciwgZC5zaXplLCBkLnVzYWdlKSk7XG5cbiAgICB0aGlzLnRlbnNvckRhdGFQZW5kaW5nRGlzcG9zYWwgPSBbXTtcbiAgICB0aGlzLnVuaWZvcm1QZW5kaW5nRGlzcG9zYWwgPSBbXTtcbiAgICB0aGlzLnN0YWdpbmdQZW5kaW5nRGlzcG9zYWwgPSBbXTtcbiAgfVxuXG4gIGVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKSB7XG4gICAgaWYgKCF0aGlzLmN1cnJlbnRDb21tYW5kRW5jb2Rlcikge1xuICAgICAgdGhpcy5jdXJyZW50Q29tbWFuZEVuY29kZXIgPSB0aGlzLmRldmljZS5jcmVhdGVDb21tYW5kRW5jb2RlcigpO1xuICAgIH1cbiAgfVxuXG4gIGVuc3VyZUNvbXB1dGVQYXNzRW5kZWQoKSB7XG4gICAgaWYgKHRoaXMuY3VycmVudENvbXB1dGVQYXNzKSB7XG4gICAgICB0aGlzLmN1cnJlbnRDb21wdXRlUGFzcy5lbmQoKTtcbiAgICAgIHRoaXMuY3VycmVudENvbXB1dGVQYXNzID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBnZXRDb21wdXRlUGFzcygpIHtcbiAgICBpZiAoIXRoaXMuY3VycmVudENvbXB1dGVQYXNzKSB7XG4gICAgICB0aGlzLmN1cnJlbnRDb21wdXRlUGFzcyA9IHRoaXMuY3VycmVudENvbW1hbmRFbmNvZGVyLmJlZ2luQ29tcHV0ZVBhc3MoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudENvbXB1dGVQYXNzO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldEJ1ZmZlckRhdGEoYnVmZmVyOiBHUFVCdWZmZXIsIHNpemU6IG51bWJlcik6XG4gICAgICBQcm9taXNlPEFycmF5QnVmZmVyPiB7XG4gICAgY29uc3Qgc3RhZ2luZyA9IHRoaXMuYnVmZmVyTWFuYWdlci5hY3F1aXJlQnVmZmVyKFxuICAgICAgICBzaXplLCBHUFVCdWZmZXJVc2FnZS5DT1BZX0RTVCB8IEdQVUJ1ZmZlclVzYWdlLk1BUF9SRUFEKTtcbiAgICB0aGlzLmVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKTtcbiAgICB0aGlzLmVuc3VyZUNvbXB1dGVQYXNzRW5kZWQoKTtcbiAgICB0aGlzLmN1cnJlbnRDb21tYW5kRW5jb2Rlci5jb3B5QnVmZmVyVG9CdWZmZXIoYnVmZmVyLCAwLCBzdGFnaW5nLCAwLCBzaXplKTtcbiAgICB0aGlzLnN1Ym1pdFF1ZXVlKCk7XG5cbiAgICBhd2FpdCBzdGFnaW5nLm1hcEFzeW5jKEdQVU1hcE1vZGUuUkVBRCk7XG4gICAgY29uc3QgdmFsdWVzID0gc3RhZ2luZy5nZXRNYXBwZWRSYW5nZSgpLnNsaWNlKDApO1xuXG4gICAgc3RhZ2luZy51bm1hcCgpO1xuICAgIGlmIChzdGFnaW5nICE9IG51bGwpIHtcbiAgICAgIHRoaXMuYnVmZmVyTWFuYWdlci5yZWxlYXNlQnVmZmVyKFxuICAgICAgICAgIHN0YWdpbmcsIHNpemUsIEdQVUJ1ZmZlclVzYWdlLkNPUFlfRFNUIHwgR1BVQnVmZmVyVXNhZ2UuTUFQX1JFQUQpO1xuICAgIH1cblxuICAgIC8vIE5lZWQgdG8gZ2V0IHRleHR1cmUgZnJvbSBzd2FwQ2hhaW4gdG8gZW5hYmxlIHByb2ZpbGluZyB0b29sXG4gICAgLy8gdG8gY2FwdHVyZSBhIGZyYW1lXG4gICAgaWYgKGVudigpLmdldEJvb2woJ1dFQkdQVV9VU0VfUFJPRklMRV9UT09MJykpIHtcbiAgICAgIHV0aWwuYXNzZXJ0KFxuICAgICAgICAgIHRoaXMuZHVtbXlDb250ZXh0ICE9PSB1bmRlZmluZWQsXG4gICAgICAgICAgKCkgPT4gYEZhaWwgdG8gZ2V0IGNvbnRleHQgZm9yIHByb2ZpbGluZyB0b29sYCk7XG4gICAgICB0aGlzLmR1bW15Q29udGV4dC5nZXRDdXJyZW50VGV4dHVyZSgpO1xuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZXM7XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnRBbmRDYWNoZU9uQ1BVKGRhdGFJZDogRGF0YUlkLCBkYXRhOiBCYWNrZW5kVmFsdWVzKTpcbiAgICAgIEJhY2tlbmRWYWx1ZXMge1xuICAgIGNvbnN0IHRlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICB0aGlzLnJlbGVhc2VSZXNvdXJjZShkYXRhSWQpO1xuICAgIHRlbnNvckRhdGEudmFsdWVzID0gZGF0YTtcbiAgICByZXR1cm4gdGVuc29yRGF0YS52YWx1ZXM7XG4gIH1cblxuICAvLyBUT0RPOiBSZW1vdmUgb25jZSB0aGlzIGlzIGZpeGVkOlxuICAvLyBodHRwczovL2dpdGh1Yi5jb20vdGVuc29yZmxvdy90ZmpzL2lzc3Vlcy8xNTk1XG4gIG92ZXJyaWRlIHJlYWRTeW5jKGRhdGFJZDogb2JqZWN0KTogQmFja2VuZFZhbHVlcyB7XG4gICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuICAgIGNvbnN0IHt2YWx1ZXN9ID0gdGVuc29yRGF0YTtcblxuICAgIGlmICh2YWx1ZXMgPT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdXZWJHUFUgcmVhZFN5bmMgaXMgb25seSBhdmFpbGFibGUgZm9yIENQVS1yZXNpZGVudCB0ZW5zb3JzLicpO1xuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZXM7XG4gIH1cblxuICBvdmVycmlkZSBhc3luYyByZWFkKGRhdGFJZDogb2JqZWN0KTogUHJvbWlzZTxCYWNrZW5kVmFsdWVzPiB7XG4gICAgaWYgKCF0aGlzLnRlbnNvck1hcC5oYXMoZGF0YUlkKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUZW5zb3IgJHtkYXRhSWR9IHdhcyBub3QgcmVnaXN0ZXJlZCFgKTtcbiAgICB9XG4gICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuXG4gICAgY29uc3Qge3ZhbHVlc30gPSB0ZW5zb3JEYXRhO1xuXG4gICAgaWYgKHZhbHVlcyAhPSBudWxsKSB7XG4gICAgICByZXR1cm4gdGhpcy5jb252ZXJ0QW5kQ2FjaGVPbkNQVShkYXRhSWQsIHZhbHVlcyk7XG4gICAgfVxuXG4gICAgLy8gRG93bmxvYWQgdGhlIHZhbHVlcyBmcm9tIHRoZSBHUFUuXG4gICAgbGV0IHZhbHM6IEJhY2tlbmRWYWx1ZXM7XG4gICAgaWYgKHRlbnNvckRhdGEuZHR5cGUgPT09ICdjb21wbGV4NjQnKSB7XG4gICAgICBjb25zdCBwcyA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgdGhpcy5yZWFkKHRlbnNvckRhdGEuY29tcGxleFRlbnNvckluZm9zLnJlYWwuZGF0YUlkKSxcbiAgICAgICAgdGhpcy5yZWFkKHRlbnNvckRhdGEuY29tcGxleFRlbnNvckluZm9zLmltYWcuZGF0YUlkKVxuICAgICAgXSk7XG5cbiAgICAgIGNvbnN0IHJlYWxWYWx1ZXMgPSBwc1swXTtcbiAgICAgIGNvbnN0IGltYWdWYWx1ZXMgPSBwc1sxXTtcbiAgICAgIHZhbHMgPSBiYWNrZW5kX3V0aWwubWVyZ2VSZWFsQW5kSW1hZ0FycmF5cyhcbiAgICAgICAgICByZWFsVmFsdWVzIGFzIEZsb2F0MzJBcnJheSwgaW1hZ1ZhbHVlcyBhcyBGbG9hdDMyQXJyYXkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBidWZmZXJJbmZvID0gdGVuc29yRGF0YS5yZXNvdXJjZUluZm8gYXMgQnVmZmVySW5mbztcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLmdldEJ1ZmZlckRhdGEoYnVmZmVySW5mby5idWZmZXIsIGJ1ZmZlckluZm8uc2l6ZSk7XG4gICAgICB2YWxzID0gdXRpbC5jb252ZXJ0QmFja2VuZFZhbHVlc0FuZEFycmF5QnVmZmVyKGRhdGEsIHRlbnNvckRhdGEuZHR5cGUpO1xuICAgIH1cbiAgICB0aGlzLmNvbnZlcnRBbmRDYWNoZU9uQ1BVKGRhdGFJZCwgdmFscyk7XG4gICAgcmV0dXJuIHZhbHM7XG4gIH1cblxuICAvLyBUaGUgc291cmNlIEdQVUJ1ZmZlciBhbmQgZGVzdGluYXRpb24gR1BVQnVmZmVyIGhhdmUgdGhlIHNhbWUgc2l6ZSBhbmRcbiAgLy8gdXNhZ2UuXG4gIHByaXZhdGUgY29weUJ1ZmZlcihzcmNCdWZmZXI6IEdQVUJ1ZmZlciwgc2l6ZTogbnVtYmVyLCB1c2FnZTogbnVtYmVyKSB7XG4gICAgY29uc3QgZHN0QnVmZmVyID0gdGhpcy5idWZmZXJNYW5hZ2VyLmFjcXVpcmVCdWZmZXIoc2l6ZSwgdXNhZ2UpO1xuICAgIHRoaXMuZW5zdXJlQ29tbWFuZEVuY29kZXJSZWFkeSgpO1xuICAgIHRoaXMuZW5zdXJlQ29tcHV0ZVBhc3NFbmRlZCgpO1xuICAgIHRoaXMuY3VycmVudENvbW1hbmRFbmNvZGVyLmNvcHlCdWZmZXJUb0J1ZmZlcihcbiAgICAgICAgc3JjQnVmZmVyLCAwLCBkc3RCdWZmZXIsIDAsIHNpemUpO1xuICAgIHRoaXMuc3VibWl0UXVldWUoKTtcbiAgICByZXR1cm4gZHN0QnVmZmVyO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIFRGLmpzIHRlbnNvciBvdXQgb2YgYW4gZXhpc3RpbmcgV2ViR1BVIGJ1ZmZlci5cbiAgICovXG4gIG92ZXJyaWRlIGNyZWF0ZVRlbnNvckZyb21HUFVEYXRhKFxuICAgICAgdmFsdWVzOiBXZWJHUFVEYXRhLCBzaGFwZTogbnVtYmVyW10sIGR0eXBlOiBEYXRhVHlwZSk6IFRlbnNvciB7XG4gICAgbGV0IGJ1ZmZlciA9IHZhbHVlcy5idWZmZXI7XG4gICAgaWYgKGR0eXBlID09PSAnY29tcGxleDY0Jykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qgd3JpdGUgdG8gYSBjb21wbGV4NjQgZHR5cGUuIGApO1xuICAgIH1cbiAgICBjb25zdCBkYXRhSWQgPSB7aWQ6IHRoaXMubmV4dERhdGFJZCgpfTtcbiAgICB0aGlzLnRlbnNvck1hcC5zZXQoXG4gICAgICAgIGRhdGFJZCxcbiAgICAgICAge2R0eXBlLCBzaGFwZSwgdmFsdWVzOiBudWxsLCByZWZDb3VudDogMSwgZXh0ZXJuYWw6IHZhbHVlcy56ZXJvQ29weX0pO1xuICAgIGNvbnN0IHRlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICBjb25zdCBzaXplID0gd2ViZ3B1X3V0aWwuR1BVQnl0ZXNQZXJFbGVtZW50KHRlbnNvckRhdGEuZHR5cGUpICpcbiAgICAgICAgdXRpbC5zaXplRnJvbVNoYXBlKHRlbnNvckRhdGEuc2hhcGUpO1xuICAgIGlmICh2YWx1ZXMuYnVmZmVyLnNpemUgPCBzaXplKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEdQVUJ1ZmZlciBzaXplKCR7XG4gICAgICAgICAgdmFsdWVzLmJ1ZmZlci5zaXplfSkgaXMgc21hbGxlciB0aGFuIHRlbnNvciBzaXplKCR7c2l6ZX0pIWApO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICAgICh2YWx1ZXMuYnVmZmVyLnVzYWdlICZcbiAgICAgICAgIChHUFVCdWZmZXJVc2FnZS5TVE9SQUdFIHwgR1BVQnVmZmVyVXNhZ2UuQ09QWV9TUkMpKSAhPT1cbiAgICAgICAgKEdQVUJ1ZmZlclVzYWdlLlNUT1JBR0UgfCBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnR1BVQnVmZmVyLnVzYWdlIHNob3VsZCBpbmNsdWRlIEdQVUJ1ZmZlclVzYWdlLlNUT1JBR0UgfCBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQyEnKTtcbiAgICB9XG5cbiAgICAvLyBEbyBidWZmZXIgY29weSBieSBkZWZhdWx0LlxuICAgIGlmICh2YWx1ZXMuemVyb0NvcHkgIT09IHRydWUpIHtcbiAgICAgIGJ1ZmZlciA9IHRoaXMuY29weUJ1ZmZlcihidWZmZXIsIHNpemUsIGJ1ZmZlci51c2FnZSk7XG4gICAgfVxuICAgIHRlbnNvckRhdGEucmVzb3VyY2VJbmZvID0ge3NpemU6IGJ1ZmZlci5zaXplLCB1c2FnZTogYnVmZmVyLnVzYWdlLCBidWZmZXJ9O1xuICAgIHJldHVybiBlbmdpbmUoKS5tYWtlVGVuc29yRnJvbURhdGFJZChkYXRhSWQsIHNoYXBlLCBkdHlwZSwgdGhpcyk7XG4gIH1cblxuICAvKipcbiAgICogUmVhZCB0ZW5zb3IgdG8gYSBuZXcgR1BVQnVmZmVyLlxuICAgKiBAcGFyYW0gZGF0YUlkIFRoZSBzb3VyY2UgdGVuc29yLlxuICAgKi9cbiAgb3ZlcnJpZGUgcmVhZFRvR1BVKGRhdGFJZDogRGF0YUlkKTogR1BVRGF0YSB7XG4gICAgY29uc3Qgc3JjVGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuICAgIGNvbnN0IHt2YWx1ZXMsIGR0eXBlLCBzaGFwZSwgcmVzb3VyY2VJbmZvfSA9IHNyY1RlbnNvckRhdGE7XG5cbiAgICBpZiAoZHR5cGUgPT09ICdjb21wbGV4NjQnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvZXMgbm90IHN1cHBvcnQgcmVhZGluZyBidWZmZXIgZm9yIGNvbXBsZXg2NCBkdHlwZS4nKTtcbiAgICB9XG5cbiAgICBpZiAocmVzb3VyY2VJbmZvID09IG51bGwpIHtcbiAgICAgIGlmICh2YWx1ZXMgIT0gbnVsbCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGEgaXMgbm90IG9uIEdQVSBidXQgb24gQ1BVLicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGVyZSBpcyBubyBkYXRhIG9uIEdQVSBvciBDUFUuJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qgc2l6ZSA9IChyZXNvdXJjZUluZm8gYXMgQnVmZmVySW5mbykuc2l6ZTtcbiAgICBjb25zdCBidWZmZXIgPSB0aGlzLmJ1ZmZlck1hbmFnZXIuYWNxdWlyZUJ1ZmZlcihzaXplLCByZXNvdXJjZUluZm8udXNhZ2UpO1xuICAgIHRoaXMuZW5zdXJlQ29tbWFuZEVuY29kZXJSZWFkeSgpO1xuICAgIHRoaXMuZW5zdXJlQ29tcHV0ZVBhc3NFbmRlZCgpO1xuICAgIHRoaXMuY3VycmVudENvbW1hbmRFbmNvZGVyLmNvcHlCdWZmZXJUb0J1ZmZlcihcbiAgICAgICAgKHJlc291cmNlSW5mbyBhcyBCdWZmZXJJbmZvKS5idWZmZXIsIDAsIGJ1ZmZlciwgMCwgc2l6ZSk7XG4gICAgdGhpcy5zdWJtaXRRdWV1ZSgpO1xuXG4gICAgY29uc3QgdGVuc29ySW5mbyA9IHRoaXMubWFrZVRlbnNvckluZm8oc2hhcGUsIGR0eXBlKTtcbiAgICAvLyBNYWtlIGVuZ2luZSB0cmFjayB0aGlzIHRlbnNvciwgc28gdGhhdCB3ZSBjYW4gZGlzcG9zZSBpdCBsYXRlci5cbiAgICBjb25zdCB0ZW5zb3JSZWYgPSBlbmdpbmUoKS5tYWtlVGVuc29yRnJvbVRlbnNvckluZm8odGVuc29ySW5mbyk7XG5cbiAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KHRlbnNvckluZm8uZGF0YUlkKTtcbiAgICB0ZW5zb3JEYXRhXG4gICAgICAgIC5yZXNvdXJjZUluZm8gPSB7c2l6ZSwgdXNhZ2U6IHRoaXMuZGVmYXVsdEdwdUJ1ZmZlclVzYWdlKCksIGJ1ZmZlcn07XG5cbiAgICByZXR1cm4ge3RlbnNvclJlZiwgYnVmZmVyLCBidWZTaXplOiBzaXplfTtcbiAgfVxuXG4gIGJ1ZmZlclN5bmM8UiBleHRlbmRzIFJhbmssIEQgZXh0ZW5kcyBEYXRhVHlwZT4odDogVGVuc29ySW5mbyk6XG4gICAgICBUZW5zb3JCdWZmZXI8UiwgRD4ge1xuICAgIGNvbnN0IGRhdGEgPSB0aGlzLnJlYWRTeW5jKHQuZGF0YUlkKTtcbiAgICBpZiAodC5kdHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIERlY29kZSB0aGUgYnl0ZXMgaW50byBzdHJpbmcuXG4gICAgICAgIGNvbnN0IHN0cmluZ3MgPSAoZGF0YSBhcyBVaW50OEFycmF5W10pLm1hcChkID0+IHV0aWwuZGVjb2RlU3RyaW5nKGQpKTtcbiAgICAgICAgcmV0dXJuIGJ1ZmZlcih0LnNoYXBlIGFzIFNoYXBlTWFwW1JdLCB0LmR0eXBlLCBzdHJpbmdzKSBhc1xuICAgICAgICAgICAgVGVuc29yQnVmZmVyPFIsIEQ+O1xuICAgICAgfSBjYXRjaCB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGRlY29kZSBlbmNvZGVkIHN0cmluZyBieXRlcyBpbnRvIHV0Zi04Jyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBidWZmZXIodC5zaGFwZSBhcyBTaGFwZU1hcFtSXSwgdC5kdHlwZSwgZGF0YSBhcyBUeXBlZEFycmF5KSBhc1xuICAgICAgICBUZW5zb3JCdWZmZXI8UiwgRD47XG4gIH1cblxuICBvdmVycmlkZSBhc3luYyB0aW1lKGY6ICgpID0+IHZvaWQpOiBQcm9taXNlPFdlYkdQVVRpbWluZ0luZm8+IHtcbiAgICBpZiAoIXRoaXMuc3VwcG9ydFRpbWVRdWVyeSkge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgIGBUaGlzIGRldmljZSBkb2Vzbid0IHN1cHBvcnQgdGltZXN0YW1wLXF1ZXJ5LWluc2lkZS1wYXNzZXMgZXh0ZW5zaW9uLiBgICtcbiAgICAgICAgICBgU3RhcnQgQ2hyb21lIGJyb3dzZXIgd2l0aCBmbGFnIGAgK1xuICAgICAgICAgIGAtLWRpc2FibGUtZGF3bi1mZWF0dXJlcz1kaXNhbGxvd191bnNhZmVfYXBpcyB0aGVuIHRyeSBhZ2Fpbi4gYCArXG4gICAgICAgICAgYE90aGVyd2lzZSwgemVybyB3aWxsIGJlIHNob3duIGZvciB0aGUga2VybmVsIHRpbWUgd2hlbiBwcm9maWxpbmcgYCArXG4gICAgICAgICAgYG1vZGUgaXMgZW5hYmxlZC4gVXNpbmcgcGVyZm9ybWFuY2Uubm93IGlzIG5vdCB3b3JrYWJsZSBmb3Igd2ViZ3B1IGAgK1xuICAgICAgICAgIGBzaW5jZSBpdCBkb2Vzbid0IHN1cHBvcnQgc3luY2hyb25vdXMgZGF0YSByZWFkIGZyb20gR1BVLmApO1xuICAgIH1cbiAgICBjb25zdCBvbGRBY3RpdmVUaW1lcnMgPSB0aGlzLmFjdGl2ZVRpbWVycztcbiAgICBjb25zdCBuZXdBY3RpdmVUaW1lcnM6IFRpbWVyTm9kZVtdID0gW107XG5cbiAgICBsZXQgb3V0ZXJNb3N0VGltZSA9IGZhbHNlO1xuICAgIGlmICh0aGlzLnByb2dyYW1UaW1lcnNTdGFjayA9PSBudWxsKSB7XG4gICAgICB0aGlzLnByb2dyYW1UaW1lcnNTdGFjayA9IG5ld0FjdGl2ZVRpbWVycztcbiAgICAgIG91dGVyTW9zdFRpbWUgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmFjdGl2ZVRpbWVycy5wdXNoKG5ld0FjdGl2ZVRpbWVycyk7XG4gICAgfVxuICAgIHRoaXMuYWN0aXZlVGltZXJzID0gbmV3QWN0aXZlVGltZXJzO1xuXG4gICAgZigpO1xuXG4gICAgY29uc3QgZmxhdHRlbmVkQWN0aXZlVGltZXJRdWVyaWVzID1cbiAgICAgICAgdXRpbC5mbGF0dGVuKHRoaXMuYWN0aXZlVGltZXJzLm1hcCgoZDogV2ViR1BVS2VybmVsSW5mbykgPT4gZC5xdWVyeSkpXG4gICAgICAgICAgICAuZmlsdGVyKGQgPT4gZCAhPSBudWxsKTtcbiAgICBjb25zdCBmbGF0dGVuZWRBY3RpdmVUaW1lck5hbWVzID1cbiAgICAgICAgdXRpbC5mbGF0dGVuKHRoaXMuYWN0aXZlVGltZXJzLm1hcCgoZDogV2ViR1BVS2VybmVsSW5mbykgPT4gZC5uYW1lKSlcbiAgICAgICAgICAgIC5maWx0ZXIoZCA9PiBkICE9IG51bGwpO1xuXG4gICAgdGhpcy5hY3RpdmVUaW1lcnMgPSBvbGRBY3RpdmVUaW1lcnM7XG5cbiAgICBpZiAob3V0ZXJNb3N0VGltZSkge1xuICAgICAgdGhpcy5wcm9ncmFtVGltZXJzU3RhY2sgPSBudWxsO1xuICAgIH1cbiAgICBjb25zdCByZXM6IFdlYkdQVVRpbWluZ0luZm8gPSB7XG4gICAgICB1cGxvYWRXYWl0TXM6IHRoaXMudXBsb2FkV2FpdE1zLFxuICAgICAgZG93bmxvYWRXYWl0TXM6IHRoaXMuZG93bmxvYWRXYWl0TXMsXG4gICAgICBrZXJuZWxNczogbnVsbCxcbiAgICAgIHdhbGxNczogbnVsbFxuICAgIH07XG5cbiAgICBjb25zdCBrZXJuZWxNcyA9IGF3YWl0IFByb21pc2UuYWxsKGZsYXR0ZW5lZEFjdGl2ZVRpbWVyUXVlcmllcyk7XG4gICAgcmVzWydrZXJuZWxNcyddID0gdXRpbC5zdW0oa2VybmVsTXMpO1xuICAgIHJlc1snZ2V0RXh0cmFQcm9maWxlSW5mbyddID0gKCkgPT5cbiAgICAgICAga2VybmVsTXMubWFwKChkLCBpKSA9PiAoe25hbWU6IGZsYXR0ZW5lZEFjdGl2ZVRpbWVyTmFtZXNbaV0sIG1zOiBkfSkpXG4gICAgICAgICAgICAubWFwKGQgPT4gYCR7ZC5uYW1lfTogJHtkLm1zfWApXG4gICAgICAgICAgICAuam9pbignLCAnKTtcbiAgICB0aGlzLnVwbG9hZFdhaXRNcyA9IDA7XG4gICAgdGhpcy5kb3dubG9hZFdhaXRNcyA9IDA7XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIG1ha2VUZW5zb3JJbmZvKFxuICAgICAgc2hhcGU6IG51bWJlcltdLCBkdHlwZTogRGF0YVR5cGUsXG4gICAgICB2YWx1ZXM/OiBCYWNrZW5kVmFsdWVzfHN0cmluZ1tdKTogVGVuc29ySW5mbyB7XG4gICAgaWYgKGR0eXBlID09PSAnc3RyaW5nJyAmJiB2YWx1ZXMgIT0gbnVsbCAmJiB2YWx1ZXMubGVuZ3RoID4gMCAmJlxuICAgICAgICB1dGlsLmlzU3RyaW5nKHZhbHVlc1swXSkpIHtcbiAgICAgIHZhbHVlcyA9ICh2YWx1ZXMgYXMgdW5rbm93biBhcyBzdHJpbmdbXSkubWFwKGQgPT4gdXRpbC5lbmNvZGVTdHJpbmcoZCkpO1xuICAgIH1cbiAgICBjb25zdCBkYXRhSWQgPSB0aGlzLndyaXRlKHZhbHVlcyBhcyBCYWNrZW5kVmFsdWVzLCBzaGFwZSwgZHR5cGUpO1xuICAgIHJldHVybiB7ZGF0YUlkLCBzaGFwZSwgZHR5cGV9O1xuICB9XG5cbiAgcHJpdmF0ZSB0ZW5zb3JUb0JpbmRpbmcodGVuc29yPzogVGVuc29ySW5mbyk6IEdQVUJpbmRpbmdSZXNvdXJjZSB7XG4gICAgaWYgKCF0ZW5zb3IpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHRlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQodGVuc29yLmRhdGFJZCk7XG4gICAgaWYgKCd0ZXh0dXJlJyBpbiB0ZW5zb3JEYXRhLnJlc291cmNlSW5mbykge1xuICAgICAgY29uc3QgaW5mbyA9IHRlbnNvckRhdGEucmVzb3VyY2VJbmZvO1xuICAgICAgaWYgKGluZm8udGV4dHVyZSBpbnN0YW5jZW9mIEdQVUV4dGVybmFsVGV4dHVyZSkge1xuICAgICAgICByZXR1cm4gaW5mby50ZXh0dXJlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGluZm8udGV4dHVyZS5jcmVhdGVWaWV3KCk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGJ1ZmZlckluZm8gPSB0ZW5zb3JEYXRhLnJlc291cmNlSW5mbztcbiAgICByZXR1cm4ge29mZnNldDogMCwgc2l6ZTogYnVmZmVySW5mby5zaXplLCBidWZmZXI6IGJ1ZmZlckluZm8uYnVmZmVyfTtcbiAgfVxuXG4gIGFzeW5jIGdldFF1ZXJ5VGltZShxdWVyeTogR1BVUXVlcnlTZXQpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGlmICh0aGlzLnN1cHBvcnRUaW1lUXVlcnkpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldFRpbWVGcm9tUXVlcnlTZXQocXVlcnkpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gIH1cblxuICB1cGxvYWRUb0dQVShkYXRhSWQ6IERhdGFJZCk6IHZvaWQge1xuICAgIGNvbnN0IHRlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICAvLyBBbHJlYWR5IG9uIHRoZSBHUFUuXG4gICAgaWYgKHRlbnNvckRhdGEucmVzb3VyY2VJbmZvKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3Qgc2l6ZSA9IHdlYmdwdV91dGlsLkdQVUJ5dGVzUGVyRWxlbWVudCh0ZW5zb3JEYXRhLmR0eXBlKSAqXG4gICAgICAgIHV0aWwuc2l6ZUZyb21TaGFwZSh0ZW5zb3JEYXRhLnNoYXBlKTtcbiAgICBjb25zdCBidWZmZXIgPVxuICAgICAgICB0aGlzLmJ1ZmZlck1hbmFnZXIuYWNxdWlyZUJ1ZmZlcihzaXplLCB0aGlzLmRlZmF1bHRHcHVCdWZmZXJVc2FnZSgpKTtcblxuICAgIHRlbnNvckRhdGFcbiAgICAgICAgLnJlc291cmNlSW5mbyA9IHtzaXplLCB1c2FnZTogdGhpcy5kZWZhdWx0R3B1QnVmZmVyVXNhZ2UoKSwgYnVmZmVyfTtcbiAgICBpZiAodGVuc29yRGF0YS52YWx1ZXMpIHtcbiAgICAgIGNvbnN0IHN0YWdpbmdCdWZmZXIgPSB0aGlzLmJ1ZmZlck1hbmFnZXIuYWNxdWlyZVVwbG9hZEJ1ZmZlcihcbiAgICAgICAgICBzaXplLCBHUFVCdWZmZXJVc2FnZS5NQVBfV1JJVEUgfCBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQyk7XG4gICAgICBjb25zdCBhcnJheUJ1ZmZlciA9IHN0YWdpbmdCdWZmZXIuZ2V0TWFwcGVkUmFuZ2UoKTtcbiAgICAgIGlmICh0ZW5zb3JEYXRhLmR0eXBlID09PSAnaW50MzInIHx8IHRlbnNvckRhdGEuZHR5cGUgPT09ICdib29sJykge1xuICAgICAgICBuZXcgSW50MzJBcnJheShhcnJheUJ1ZmZlcikuc2V0KHRlbnNvckRhdGEudmFsdWVzIGFzIFR5cGVkQXJyYXkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV3IEZsb2F0MzJBcnJheShhcnJheUJ1ZmZlcikuc2V0KHRlbnNvckRhdGEudmFsdWVzIGFzIEZsb2F0MzJBcnJheSk7XG4gICAgICB9XG4gICAgICBzdGFnaW5nQnVmZmVyLnVubWFwKCk7XG4gICAgICB0aGlzLmVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKTtcbiAgICAgIHRoaXMuZW5zdXJlQ29tcHV0ZVBhc3NFbmRlZCgpO1xuICAgICAgdGhpcy5jdXJyZW50Q29tbWFuZEVuY29kZXIuY29weUJ1ZmZlclRvQnVmZmVyKFxuICAgICAgICAgIHN0YWdpbmdCdWZmZXIsIDAsIGJ1ZmZlciwgMCwgc2l6ZSk7XG5cbiAgICAgIGNvbnN0IHN0YWdpbmdJbmZvID0ge1xuICAgICAgICBzaXplLFxuICAgICAgICB1c2FnZTogR1BVQnVmZmVyVXNhZ2UuTUFQX1dSSVRFIHwgR1BVQnVmZmVyVXNhZ2UuQ09QWV9TUkMsXG4gICAgICAgIGJ1ZmZlcjogc3RhZ2luZ0J1ZmZlclxuICAgICAgfTtcbiAgICAgIHRoaXMuc3RhZ2luZ1BlbmRpbmdEaXNwb3NhbC5wdXNoKHN0YWdpbmdJbmZvKTtcbiAgICAgIC8vIFRPRE86IFdlYkdQVSBkb2Vzbid0IHN1cHBvcnQgcmVhZCBkYXRhIHN5bmNocm9ub3VzbHkgZnJvbSBHUFUgdG8gQ1BVLlxuICAgICAgLy8gU28gaXQgd2lsbCByZXBvcnQgZXJyb3Igd2hlbiBzd2l0Y2hpbmcgYmFja2VuZCBmcm9tIFdlYkdQVSB0byBvdGhlcnMuXG4gICAgICAvLyBUaGVyZSBhcmUgdHdvIHNpdHVhdGlvbnM6IDEpIHN3aXRoY2luZyB0aGUgYmFja2VuZCBhZnRlciBydW5uaW5nIGFcbiAgICAgIC8vIG1vZGVsOyAyKSBzd2l0aGNpbmcgdGhlIGJhY2tlbmQgd2l0aGluIHRoZSBtb2RlbC4gVGVtcG9yYXJpbGx5IGtlZXBcbiAgICAgIC8vIHRoZSB2YWx1ZXMgb24gQ1BVIHRvIHNvbHZlIHRoZSBmaXJzdCBpc3N1ZS4gdGVuc29yRGF0YS52YWx1ZXMgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbWFrZVVuaWZvcm1zKHByb2dyYW1Vbmlmb3JtOiBQcm9ncmFtVW5pZm9ybSk6IEdQVUJpbmRpbmdSZXNvdXJjZSB7XG4gICAgbGV0IGN1cnJlbnRPZmZzZXQgPSAwO1xuICAgIGxldCBwcmVMZW5ndGggPSAwO1xuICAgIGNvbnN0IG9mZnNldHM6IG51bWJlcltdID0gW107XG4gICAgbGV0IG1heEFsaWdubWVudE9mRmllbGQgPSAxO1xuICAgIHByb2dyYW1Vbmlmb3JtLmZvckVhY2goKGQpID0+IHtcbiAgICAgIGlmIChkLmRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGQuZGF0YSA9IFsxXTtcbiAgICAgIH1cbiAgICAgIC8vIGh0dHBzOi8vd3d3LnczLm9yZy9UUi9XR1NMLyNhbGlnbm9mXG4gICAgICBsZXQgYmFzZUFsaWdubWVudDogbnVtYmVyO1xuICAgICAgc3dpdGNoIChkLmRhdGEubGVuZ3RoKSB7XG4gICAgICAgIGNhc2UgMTpcbiAgICAgICAgICBiYXNlQWxpZ25tZW50ID0gNDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAyOlxuICAgICAgICAgIGJhc2VBbGlnbm1lbnQgPSA4O1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIDM6XG4gICAgICAgICAgYmFzZUFsaWdubWVudCA9IDE2O1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIDQ6XG4gICAgICAgICAgYmFzZUFsaWdubWVudCA9IDE2O1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIDU6XG4gICAgICAgICAgYmFzZUFsaWdubWVudCA9IDE2O1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIDY6XG4gICAgICAgICAgYmFzZUFsaWdubWVudCA9IDE2O1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHV0aWwuYXNzZXJ0KGZhbHNlLCAoKSA9PiBgVW5zdXBwb3J0ZWQgJHtkLmRhdGEubGVuZ3RofUQgc2hhcGVgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHByZUxlbmd0aCA9PT0gNSB8fCBwcmVMZW5ndGggPT09IDYpIHtcbiAgICAgICAgYmFzZUFsaWdubWVudCA9IDE2O1xuICAgICAgfVxuICAgICAgaWYgKGJhc2VBbGlnbm1lbnQgPiBtYXhBbGlnbm1lbnRPZkZpZWxkKSB7XG4gICAgICAgIG1heEFsaWdubWVudE9mRmllbGQgPSBiYXNlQWxpZ25tZW50O1xuICAgICAgfVxuICAgICAgY3VycmVudE9mZnNldCA9IE1hdGguY2VpbChjdXJyZW50T2Zmc2V0IC8gYmFzZUFsaWdubWVudCkgKiBiYXNlQWxpZ25tZW50O1xuICAgICAgcHJlTGVuZ3RoID0gZC5kYXRhLmxlbmd0aDtcbiAgICAgIG9mZnNldHMucHVzaChjdXJyZW50T2Zmc2V0KTtcbiAgICAgIGN1cnJlbnRPZmZzZXQgKz0gZC5kYXRhLmxlbmd0aCAqIDQ7XG4gICAgfSk7XG5cbiAgICBjdXJyZW50T2Zmc2V0ID1cbiAgICAgICAgTWF0aC5jZWlsKGN1cnJlbnRPZmZzZXQgLyBtYXhBbGlnbm1lbnRPZkZpZWxkKSAqIG1heEFsaWdubWVudE9mRmllbGQ7XG4gICAgY29uc3QgYXJyYXlCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoY3VycmVudE9mZnNldCk7XG4gICAgcHJvZ3JhbVVuaWZvcm0uZm9yRWFjaCgoZCwgaSkgPT4ge1xuICAgICAgY29uc3Qgb2Zmc2V0ID0gb2Zmc2V0c1tpXTtcbiAgICAgIGlmIChkLnR5cGUgPT09ICdpbnQzMicpIHtcbiAgICAgICAgbmV3IEludDMyQXJyYXkoYXJyYXlCdWZmZXIsIG9mZnNldCwgZC5kYXRhLmxlbmd0aCkuc2V0KGQuZGF0YSk7XG4gICAgICB9IGVsc2UgaWYgKGQudHlwZSA9PT0gJ3VpbnQzMicpIHtcbiAgICAgICAgbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmZmVyLCBvZmZzZXQsIGQuZGF0YS5sZW5ndGgpLnNldChkLmRhdGEpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV3IEZsb2F0MzJBcnJheShhcnJheUJ1ZmZlciwgb2Zmc2V0LCBkLmRhdGEubGVuZ3RoKS5zZXQoZC5kYXRhKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHVuaWZvcm1CdWZmZXIgPSB0aGlzLmJ1ZmZlck1hbmFnZXIuYWNxdWlyZUJ1ZmZlcihcbiAgICAgICAgY3VycmVudE9mZnNldCwgR1BVQnVmZmVyVXNhZ2UuQ09QWV9EU1QgfCBHUFVCdWZmZXJVc2FnZS5VTklGT1JNKTtcbiAgICB0aGlzLnF1ZXVlLndyaXRlQnVmZmVyKHVuaWZvcm1CdWZmZXIsIDAsIGFycmF5QnVmZmVyLCAwLCBjdXJyZW50T2Zmc2V0KTtcblxuICAgIGNvbnN0IHVuaWZvcm1JbmZvID0ge1xuICAgICAgc2l6ZTogY3VycmVudE9mZnNldCxcbiAgICAgIHVzYWdlOiBHUFVCdWZmZXJVc2FnZS5DT1BZX0RTVCB8IEdQVUJ1ZmZlclVzYWdlLlVOSUZPUk0sXG4gICAgICBidWZmZXI6IHVuaWZvcm1CdWZmZXJcbiAgICB9O1xuICAgIHRoaXMudW5pZm9ybVBlbmRpbmdEaXNwb3NhbC5wdXNoKHVuaWZvcm1JbmZvKTtcblxuICAgIHJldHVybiB7b2Zmc2V0OiAwLCBzaXplOiBjdXJyZW50T2Zmc2V0LCBidWZmZXI6IHVuaWZvcm1CdWZmZXJ9O1xuICB9XG5cbiAgcHVibGljIHJ1bldlYkdQVVByb2dyYW0oXG4gICAgICBwcm9ncmFtOiB3ZWJncHVfcHJvZ3JhbS5XZWJHUFVQcm9ncmFtLCBpbnB1dHM6IFRlbnNvckluZm9bXSxcbiAgICAgIG91dHB1dER0eXBlOiBEYXRhVHlwZSwgcHJvZ3JhbURlZmluZWRVbmlmb3JtPzogUHJvZ3JhbVVuaWZvcm0sXG4gICAgICBvdXRwdXQ/OiBUZW5zb3JJbmZvKTogVGVuc29ySW5mbyB7XG4gICAgaWYgKCFvdXRwdXQpIHtcbiAgICAgIG91dHB1dCA9IHRoaXMubWFrZVRlbnNvckluZm8ocHJvZ3JhbS5vdXRwdXRTaGFwZSwgb3V0cHV0RHR5cGUpO1xuICAgIH1cbiAgICBpZiAodXRpbC5zaXplRnJvbVNoYXBlKG91dHB1dC5zaGFwZSkgPT09IDApIHtcbiAgICAgIC8vIFNob3J0LWNpcmN1aXQgdGhlIGNvbXB1dGF0aW9uIHNpbmNlIHRoZSByZXN1bHQgaXMgZW1wdHkgKGhhcyAwIGluIGl0c1xuICAgICAgLy8gc2hhcGUpLlxuICAgICAgdGhpcy50ZW5zb3JNYXAuZ2V0KG91dHB1dC5kYXRhSWQpLnZhbHVlcyA9XG4gICAgICAgICAgdXRpbC5nZXRUeXBlZEFycmF5RnJvbURUeXBlKG91dHB1dC5kdHlwZSBhcyAnZmxvYXQzMicsIDApO1xuICAgICAgcmV0dXJuIG91dHB1dDtcbiAgICB9XG4gICAgdGhpcy51cGxvYWRUb0dQVShvdXRwdXQuZGF0YUlkKTtcbiAgICBwcm9ncmFtLmRpc3BhdGNoID0gcmVzaGFwZURpc3BhdGNoKHRoaXMuZGV2aWNlLCBwcm9ncmFtKTtcblxuICAgIC8vIFRoZXJlIGFyZSBzaXgga2luZHMgb2YgdW5pZm9ybXM6IE5BTiwgSU5GSU5JVFksIHNoYXBlcywgc2hhcGUgc3RyaWRlcyxcbiAgICAvLyBwcm9ncmFtIHNpemUsIHByb2dyYW0gZGVmaW5lZCB1bmlmb3Jtcy5cbiAgICBsZXQgcHJvZ3JhbVVuaWZvcm06IFByb2dyYW1Vbmlmb3JtID0gW107XG4gICAgbGV0IGJ1ZmZlclNoYXBlczogbnVtYmVyW11bXSA9IFtdO1xuICAgIGlmICghcHJvZ3JhbS5pc0Zyb21QaXhlbHMpIHtcbiAgICAgIHByb2dyYW1Vbmlmb3JtLnB1c2goXG4gICAgICAgICAge3R5cGU6ICdmbG9hdDMyJywgZGF0YTogW05hTl19LCB7dHlwZTogJ2Zsb2F0MzInLCBkYXRhOiBbSW5maW5pdHldfSk7XG4gICAgICBidWZmZXJTaGFwZXMgPSBpbnB1dHMuY29uY2F0KG91dHB1dCkubWFwKGQgPT4gZC5zaGFwZSk7XG4gICAgICBjb25zdCB1bmlmb3Jtc1R5cGUgPSAnaW50MzInO1xuICAgICAgYnVmZmVyU2hhcGVzLm1hcChkID0+IHtcbiAgICAgICAgcHJvZ3JhbVVuaWZvcm0ucHVzaCh7dHlwZTogdW5pZm9ybXNUeXBlLCBkYXRhOiBkfSk7XG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHN0cmlkZXMgPSB1dGlsLmNvbXB1dGVTdHJpZGVzKG91dHB1dC5zaGFwZSk7XG4gICAgICBwcm9ncmFtVW5pZm9ybS5wdXNoKHt0eXBlOiB1bmlmb3Jtc1R5cGUsIGRhdGE6IHN0cmlkZXN9KTtcbiAgICAgIGlmIChwcm9ncmFtLnNpemUpIHtcbiAgICAgICAgY29uc3Qgc2l6ZSA9IHV0aWwuc2l6ZUZyb21TaGFwZShwcm9ncmFtLm91dHB1dFNoYXBlKTtcbiAgICAgICAgcHJvZ3JhbVVuaWZvcm0ucHVzaChcbiAgICAgICAgICAgIHt0eXBlOiB1bmlmb3Jtc1R5cGUsIGRhdGE6IFtwcm9ncmFtLmlzVmVjNCA/IHNpemUgLyA0IDogc2l6ZV19KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBpbnB1dHNEYXRhID0gaW5wdXRzLm1hcCgoaW5wdXQ6IFRlbnNvckluZm8sIGk6IG51bWJlcikgPT4ge1xuICAgICAgaWYgKGlucHV0LmR0eXBlID09PSAnY29tcGxleDY0Jykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgR1BHUFVQcm9ncmFtIGRvZXMgbm90IHN1cHBvcnQgY29tcGxleDY0IGlucHV0LiBGb3IgY29tcGxleDY0IGAgK1xuICAgICAgICAgICAgYGR0eXBlcywgcGxlYXNlIHNlcGFyYXRlIHRoZSBwcm9ncmFtIGludG8gcmVhbCBhbmQgaW1hZ2luYXJ5IGAgK1xuICAgICAgICAgICAgYHBhcnRzLmApO1xuICAgICAgfVxuICAgICAgdGhpcy51cGxvYWRUb0dQVShpbnB1dC5kYXRhSWQpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICAvLyBSZXR1cm5pbmcgZHR5cGUgZnJvbSB0ZW5zb3JNYXAgYmVjYXVzZSBpdCByZWZsZWN0cyBkdHlwZVxuICAgICAgICAvLyBvZiB1bmRlcmx5aW5nIGJ1ZmZlciwgcmF0aGVyIHRoYW4gYWJzdHJhY3QgZHR5cGUuXG4gICAgICAgIGR0eXBlOiB0aGlzLnRlbnNvck1hcC5nZXQoaW5wdXQuZGF0YUlkKS5kdHlwZSxcbiAgICAgICAgc2hhcGU6IGlucHV0LnNoYXBlLFxuICAgICAgICBuYW1lOiBwcm9ncmFtLnZhcmlhYmxlTmFtZXNbaV1cbiAgICAgIH07XG4gICAgfSk7XG5cbiAgICBjb25zdCBrZXkgPVxuICAgICAgICB3ZWJncHVfcHJvZ3JhbS5tYWtlU2hhZGVyS2V5KHByb2dyYW0sIGJ1ZmZlclNoYXBlcywgaW5wdXRzRGF0YSwgb3V0cHV0KTtcblxuICAgIGxldCBwaXBlbGluZTtcbiAgICBpZiAoa2V5IGluIHRoaXMucGlwZWxpbmVDYWNoZSkge1xuICAgICAgcGlwZWxpbmUgPSB0aGlzLnBpcGVsaW5lQ2FjaGVba2V5XTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGlwZWxpbmUgPSB3ZWJncHVfcHJvZ3JhbS5jb21waWxlUHJvZ3JhbShcbiAgICAgICAgICB0aGlzLmRldmljZSwgcHJvZ3JhbSwgaW5wdXRzRGF0YSwgb3V0cHV0KTtcbiAgICAgIHRoaXMucGlwZWxpbmVDYWNoZVtrZXldID0gcGlwZWxpbmU7XG4gICAgfVxuXG4gICAgaWYgKHByb2dyYW1EZWZpbmVkVW5pZm9ybSkge1xuICAgICAgcHJvZ3JhbVVuaWZvcm0gPSBbLi4ucHJvZ3JhbVVuaWZvcm0sIC4uLnByb2dyYW1EZWZpbmVkVW5pZm9ybV07XG4gICAgfVxuICAgIGNvbnN0IGJpbmRpbmdzID0gW1xuICAgICAgdGhpcy50ZW5zb3JUb0JpbmRpbmcob3V0cHV0KSwgLi4uaW5wdXRzLm1hcCh0ID0+IHRoaXMudGVuc29yVG9CaW5kaW5nKHQpKSxcbiAgICAgIHRoaXMubWFrZVVuaWZvcm1zKHByb2dyYW1Vbmlmb3JtKVxuICAgIF07XG5cbiAgICBjb25zdCBiaW5kR3JvdXAgPSB0aGlzLmRldmljZS5jcmVhdGVCaW5kR3JvdXAoe1xuICAgICAgbGF5b3V0OiBwaXBlbGluZS5nZXRCaW5kR3JvdXBMYXlvdXQoMCksXG4gICAgICBlbnRyaWVzOiBiaW5kaW5ncy5tYXAoKGIsIGkpID0+ICh7YmluZGluZzogaSwgcmVzb3VyY2U6IGJ9KSksXG4gICAgfSk7XG5cbiAgICB0aGlzLmVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKTtcbiAgICBjb25zdCBwYXNzID0gdGhpcy5nZXRDb21wdXRlUGFzcygpO1xuICAgIGNvbnN0IHNob3VsZFRpbWVQcm9ncmFtID0gdGhpcy5hY3RpdmVUaW1lcnMgIT0gbnVsbDtcbiAgICBpZiAoc2hvdWxkVGltZVByb2dyYW0pIHtcbiAgICAgIGlmICh0aGlzLnN1cHBvcnRUaW1lUXVlcnkpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxuICAgICAgICAocGFzcyBhcyBhbnkpLndyaXRlVGltZXN0YW1wKHRoaXMucXVlcnlTZXQsIDApO1xuICAgICAgfVxuICAgIH1cbiAgICBwYXNzLnNldFBpcGVsaW5lKHBpcGVsaW5lKTtcbiAgICBwYXNzLnNldEJpbmRHcm91cCgwLCBiaW5kR3JvdXApO1xuICAgIHBhc3MuZGlzcGF0Y2hXb3JrZ3JvdXBzKFxuICAgICAgICBwcm9ncmFtLmRpc3BhdGNoWzBdLCBwcm9ncmFtLmRpc3BhdGNoWzFdLCBwcm9ncmFtLmRpc3BhdGNoWzJdKTtcbiAgICBpZiAoc2hvdWxkVGltZVByb2dyYW0pIHtcbiAgICAgIGlmICh0aGlzLnN1cHBvcnRUaW1lUXVlcnkpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxuICAgICAgICAocGFzcyBhcyBhbnkpLndyaXRlVGltZXN0YW1wKHRoaXMucXVlcnlTZXQsIDEpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmRpc3BhdGNoTnVtYmVySW5FbmNvZGVyKys7XG5cbiAgICBpbnB1dHMuZm9yRWFjaChpbnB1dCA9PiB7XG4gICAgICB0aGlzLmNvbW1hbmRRdWV1ZU93bmVkSWRzLmFkZChpbnB1dC5kYXRhSWQpO1xuICAgIH0pO1xuICAgIHRoaXMuY29tbWFuZFF1ZXVlT3duZWRJZHMuYWRkKG91dHB1dC5kYXRhSWQpO1xuXG4gICAgaWYgKGVudigpLmdldCgnV0VCR1BVX0RFRkVSUkVEX1NVQk1JVF9CQVRDSF9TSVpFJykgYXNcbiAgICAgICAgbnVtYmVyIDw9IHRoaXMuZGlzcGF0Y2hOdW1iZXJJbkVuY29kZXIpIHtcbiAgICAgIHRoaXMuc3VibWl0UXVldWUoKTtcbiAgICB9XG5cbiAgICBpZiAoc2hvdWxkVGltZVByb2dyYW0pIHtcbiAgICAgIHRoaXMuYWN0aXZlVGltZXJzLnB1c2goe1xuICAgICAgICBuYW1lOiBwcm9ncmFtLmNvbnN0cnVjdG9yLm5hbWUsXG4gICAgICAgIHF1ZXJ5OiB0aGlzLmdldFF1ZXJ5VGltZSh0aGlzLnF1ZXJ5U2V0KVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBvdXRwdXQ7XG4gIH1cblxuICBhc3luYyBnZXRUaW1lRnJvbVF1ZXJ5U2V0KHF1ZXJ5U2V0OiBHUFVRdWVyeVNldCkge1xuICAgIGNvbnN0IHF1ZXJ5QnVmZmVyID0gdGhpcy5idWZmZXJNYW5hZ2VyLmFjcXVpcmVCdWZmZXIoXG4gICAgICAgIDE2LCBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQyB8IEdQVUJ1ZmZlclVzYWdlLlFVRVJZX1JFU09MVkUpO1xuICAgIGNvbnN0IGRzdCA9IHRoaXMuYnVmZmVyTWFuYWdlci5hY3F1aXJlQnVmZmVyKFxuICAgICAgICAxNiwgR1BVQnVmZmVyVXNhZ2UuTUFQX1JFQUQgfCBHUFVCdWZmZXJVc2FnZS5DT1BZX0RTVCk7XG5cbiAgICB0aGlzLmVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKTtcbiAgICB0aGlzLmVuc3VyZUNvbXB1dGVQYXNzRW5kZWQoKTtcbiAgICB0aGlzLmN1cnJlbnRDb21tYW5kRW5jb2Rlci5yZXNvbHZlUXVlcnlTZXQocXVlcnlTZXQsIDAsIDIsIHF1ZXJ5QnVmZmVyLCAwKTtcbiAgICB0aGlzLmN1cnJlbnRDb21tYW5kRW5jb2Rlci5jb3B5QnVmZmVyVG9CdWZmZXIocXVlcnlCdWZmZXIsIDAsIGRzdCwgMCwgMTYpO1xuICAgIHRoaXMuc3VibWl0UXVldWUoKTtcbiAgICBhd2FpdCBkc3QubWFwQXN5bmMoR1BVTWFwTW9kZS5SRUFEKTtcbiAgICBjb25zdCBhcnJheUJ1ZiA9IG5ldyBCaWdVaW50NjRBcnJheShkc3QuZ2V0TWFwcGVkUmFuZ2UoKSk7XG4gICAgY29uc3QgdGltZUVsYXBzZWROYW5vcyA9IE51bWJlcigoYXJyYXlCdWZbMV0gLSBhcnJheUJ1ZlswXSkpO1xuICAgIGRzdC51bm1hcCgpO1xuICAgIHRoaXMuYnVmZmVyTWFuYWdlci5yZWxlYXNlQnVmZmVyKFxuICAgICAgICBkc3QsIDE2LCBHUFVCdWZmZXJVc2FnZS5NQVBfUkVBRCB8IEdQVUJ1ZmZlclVzYWdlLkNPUFlfRFNUKTtcbiAgICB0aGlzLmJ1ZmZlck1hbmFnZXIucmVsZWFzZUJ1ZmZlcihcbiAgICAgICAgcXVlcnlCdWZmZXIsIDE2LFxuICAgICAgICBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQyB8IEdQVUJ1ZmZlclVzYWdlLlFVRVJZX1JFU09MVkUpO1xuICAgIC8vIFJldHVybiBtaWxsaXNlY29uZHMuXG4gICAgcmV0dXJuIHRpbWVFbGFwc2VkTmFub3MgLyAxMDAwMDAwO1xuICB9XG5cbiAgc2hvdWxkRXhlY3V0ZU9uQ1BVKFxuICAgICAgaW5wdXRzOiBUZW5zb3JJbmZvW10sXG4gICAgICBzaXplVGhyZXNob2xkID0gQ1BVX0hBTkRPRkZfU0laRV9USFJFU0hPTEQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZW52KCkuZ2V0Qm9vbCgnV0VCR1BVX0NQVV9GT1JXQVJEJykgJiZcbiAgICAgICAgaW5wdXRzLmV2ZXJ5KFxuICAgICAgICAgICAgaW5wdXQgPT4gdGhpcy50ZW5zb3JNYXAuZ2V0KGlucHV0LmRhdGFJZCkucmVzb3VyY2VJbmZvID09IG51bGwgJiZcbiAgICAgICAgICAgICAgICB1dGlsLnNpemVGcm9tU2hhcGUoaW5wdXQuc2hhcGUpIDwgc2l6ZVRocmVzaG9sZCk7XG4gIH1cblxuICBvdmVycmlkZSBudW1EYXRhSWRzKCkge1xuICAgIHJldHVybiB0aGlzLnRlbnNvck1hcC5udW1EYXRhSWRzKCkgLSB0aGlzLnRlbnNvckRhdGFQZW5kaW5nRGlzcG9zYWwubGVuZ3RoO1xuICB9XG5cbiAgb3ZlcnJpZGUgZGlzcG9zZSgpIHtcbiAgICBpZiAodGhpcy5kaXNwb3NlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmJ1ZmZlck1hbmFnZXIuZGlzcG9zZSgpO1xuICAgIHRoaXMudGV4dHVyZU1hbmFnZXIuZGlzcG9zZSgpO1xuICAgIHRoaXMuZGlzcG9zZWQgPSB0cnVlO1xuICB9XG59XG4iXX0=